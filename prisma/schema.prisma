generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                             String                             @id @default(cuid())
  name                           String?
  email                          String                             @unique
  emailVerified                  DateTime?
  image                          String?
  password                       String?
  firstName                      String?
  lastName                       String?
  avatar                         String?
  phone                          String?
  location                       String?
  department                     String?
  timezone                       String                             @default("UTC")
  locale                         String                             @default("en")
  tenantId                       String
  role                           UserRole                           @default(TEAM_MEMBER)
  orgUnitId                      String?
  reportsToId                    String?
  landingPage                    String?
  status                         UserStatus                         @default(ACTIVE)
  lastLogin                      DateTime?
  resetToken                     String?
  resetTokenExpiry               DateTime?
  stripeCustomerId               String?                            @unique
  stripeSubscriptionId           String?                            @unique
  subscriptionStatus             String?                            // active, canceled, past_due, etc.
  subscriptionTier               String?                            // free, starter, professional, business, enterprise
  subscriptionStartDate          DateTime?
  subscriptionEndDate            DateTime?
  createdAt                      DateTime                           @default(now())
  updatedAt                      DateTime                           @updatedAt
  groupRole                      GroupRole?
  primaryWorkflowType            WorkflowType?
  workflowSettings               Json?
  assistantName                  String?
  voiceSampleUrl                 String?
  allowedSections                String?                            // JSON array of allowed section names, null = full access
  accessAuditLogs                AccessAuditLog[]                   @relation("AccessAuditLogs")
  accounts                       Account[]
  activityFeeds                  ActivityFeed[]                     @relation("ActivityActor")
  resolvedAnnotations            Annotation[]                       @relation("AnnotationResolver")
  annotations                    Annotation[]                       @relation("AnnotationAuthor")
  finalApprovals                 Approval[]                         @relation("ApprovalFinalApprover")
  finalRejections                Approval[]                         @relation("ApprovalFinalRejecter")
  createdApprovals               Approval[]                         @relation("ApprovalRequester")
  requestedApprovals             ApprovalApprover[]
  auditLogs                      AuditLog[]                         @relation("UserAuditLogs")
  budgetsApproved                Budget[]                           @relation("BudgetApprover")
  budgetsCreated                 Budget[]                           @relation("BudgetCreator")
  budgetApprovals                BudgetApproval[]                   @relation("BudgetApprovals")
  transfersApproved              BudgetTransfer[]                   @relation("TransferApprover")
  transfersRequested             BudgetTransfer[]                   @relation("TransferRequester")
  createdCollaborations          Collaboration[]                    @relation("CollaborationCreator")
  collaborationFiles             CollaborationFile[]
  collaborationMemberships       CollaborationMember[]
  collaborationMessages          CollaborationMessage[]
  respondedSuggestions           CollaborationSuggestion[]          @relation("SuggestionResponder")
  collaborationSuggestions       CollaborationSuggestion[]
  createdCLSRules                ColumnLevelSecurityRule[]          @relation("CLSRuleCreator")
  clsRules                       ColumnLevelSecurityRule[]          @relation("CLSUserRules")
  comments                       Comment[]                          @relation("CommentAuthor")
  generatedComplianceReports     ComplianceReport[]                 @relation("ComplianceReportGenerator")
  costsApproved                  CostActual[]                       @relation("CostApprover")
  costsCreated                   CostActual[]                       @relation("CostCreator")
  dataCatalogEntries             DataCatalogEntry[]                 @relation("DataCatalogOwner")
  createdRetentionPolicies       DataRetentionPolicy[]              @relation("RetentionPolicyCreator")
  dataUsage                      DataUsage[]                        @relation("DataUsageUser")
  defaultLayouts                 DefaultLayout[]
  financialFilesCreated          FinancialFile[]                    @relation("FinancialFileCreator")
  financialFilesProcessed        FinancialFile[]                    @relation("FinancialFileProcessor")
  createdFunctionPermissions     FunctionPermission[]               @relation("FunctionPermissionCreator")
  functionPermissions            FunctionPermission[]               @relation("UserFunctionPermissions")
  createdGrids                   Grid[]                             @relation("GridCreator")
  updatedGrids                   Grid[]                             @relation("GridUpdater")
  updatedGridCells               GridCell[]                         @relation("GridCellUpdater")
  createdIntegrations            Integration[]                      @relation("IntegrationCreator")
  createdTemplates               IntegrationTemplate[]              @relation("TemplateCreator")
  integrationTemplateReviews     IntegrationTemplateReview[]        @relation("TemplateReviewer")
  invoicesCreated                Invoice[]                          @relation("InvoiceCreator")
  paymentsCreated                InvoicePayment[]                   @relation("PaymentCreator")
  mentionsCreated                Mention[]                          @relation("MentionCreator")
  mentionsReceived               Mention[]                          @relation("MentionedUser")
  notifications                  Notification[]                     @relation("UserNotifications")
  createdOrganizationPermissions OrganizationPermission[]           @relation("PermissionCreator")
  organizationPermissions        OrganizationPermission[]           @relation("UserOrgPermissions")
  pricingModelsApproved          PricingModel[]                     @relation("PricingApprover")
  pricingModelsCreated           PricingModel[]                     @relation("PricingCreator")
  createdPrograms                Program[]                          @relation("CreatedBy")
  createdProjects                Project[]                          @relation("CreatedBy")
  managedProjects                Project[]                          @relation("ProjectManager")
  teamMemberships                ProjectMember[]
  quotesCreated                  Quote[]                            @relation("QuoteCreator")
  rlsCacheEntries                RLSCacheEntry[]                    @relation("RLSCacheEntries")
  rateCardsCreated               RateCard[]                         @relation("RateCardCreator")
  createdReminders               Reminder[]                         @relation("CreatedReminders")
  reminders                      Reminder[]                         @relation("UserReminders")
  reportingActivities            ReportingActivity[]                @relation("ReportingActivities")
  dashboardsCreated              ReportingDashboard[]               @relation("DashboardCreatedBy")
  dashboardsUpdated              ReportingDashboard[]               @relation("DashboardUpdatedBy")
  dashboardPermissions           ReportingDashboardPermission[]     @relation("DashboardPermissions")
  dataSourcesCreated             ReportingDataSource[]              @relation("DataSourceCreator")
  dataSourcesUpdated             ReportingDataSource[]              @relation("DataSourceUpdater")
  datasetsCreated                ReportingDataset[]                 @relation("DatasetCreator")
  datasetsUpdated                ReportingDataset[]                 @relation("DatasetUpdater")
  datasetPermissions             ReportingDatasetPermission[]       @relation("DatasetPermissions")
  reportingFiles                 ReportingFile[]
  insightsGenerated              ReportingInsight[]                 @relation("InsightGenerator")
  queryLogs                      ReportingQueryLog[]                @relation("QueryLogs")
  reportsCreated                 ReportingReport[]                  @relation("ReportCreator")
  reportsUpdated                 ReportingReport[]                  @relation("ReportUpdater")
  reportPermissions              ReportingReportPermission[]        @relation("ReportPermissions")
  templatesCreated               ReportingReportTemplate[]          @relation("TemplateCreator")
  templatesUpdated               ReportingReportTemplate[]          @relation("TemplateUpdater")
  transformationsCreated         ReportingTransformation[]          @relation("TransformationCreator")
  transformationsUpdated         ReportingTransformation[]          @relation("TransformationUpdater")
  insightActions                 ReportingUserInsightAction[]       @relation("UserInsightActions")
  visualizationsCreated          ReportingVisualization[]           @relation("VisualizationCreator")
  visualizationsUpdated          ReportingVisualization[]           @relation("VisualizationUpdater")
  visualizationPermissions       ReportingVisualizationPermission[] @relation("VisualizationPermissions")
  sharedResources                ResourceShare[]                    @relation("ResourceSharer")
  resourcesSharedWith            ResourceShare[]                    @relation("ResourceSharedWith")
  // New Reporting System Relations
  createdVisualizations          Visualization[]                    @relation("VisualizationCreator")
  createdDashboards              Dashboard[]                        @relation("DashboardCreator")
  createdQueries                 Query[]                            @relation("QueryCreator")
  dataSourceAccess               DataSourceAccess[]                 @relation("DataSourceAccessUser")
  dashboardShares                DashboardShare[]                   @relation("DashboardShareUser")
  createdRLSRules                RowLevelSecurityRule[]             @relation("RLSRuleCreator")
  rlsRules                       RowLevelSecurityRule[]             @relation("RLSUserRules")
  salesAccountsOwned             SalesAccount[]                     @relation("AccountOwner")
  salesActivitiesAssigned        SalesActivity[]                    @relation("ActivityAssignedTo")
  salesActivitiesCreated         SalesActivity[]                    @relation("ActivityCreatedBy")
  salesAutomationRulesCreated    SalesAutomationRule[]              @relation("AutomationRuleCreatedBy")
  salesCasesAssigned             SalesCase[]                        @relation("CaseAssignedTo")
  salesCasesCreated              SalesCase[]                        @relation("CaseCreatedBy")
  salesContactsOwned             SalesContact[]                     @relation("ContactOwner")
  salesForecasts                 SalesForecast[]                    @relation("SalesForecastUser")
  salesLeadsAssigned             SalesLead[]                        @relation("LeadAssignedTo")
  salesLeadsOwned                SalesLead[]                        @relation("LeadOwner")
  salesOpportunitiesCreated      SalesOpportunity[]                 @relation("OpportunityCreatedBy")
  salesOpportunitiesOwned        SalesOpportunity[]                 @relation("OpportunityOwner")
  salesOrdersCreated             SalesOrder[]                       @relation("OrderCreatedBy")
  salesQuotesApproved            SalesQuote[]                       @relation("QuoteApprovedBy")
  salesQuotesCreated             SalesQuote[]                       @relation("QuoteCreatedBy")
  salesQuoteTemplatesCreated     SalesQuoteTemplate[]               @relation("QuoteTemplateCreatedBy")
  vendorsCreated                 OperationsVendor[]                  @relation("VendorCreatedBy")
  vendorsUpdated                 OperationsVendor[]                  @relation("VendorUpdatedBy")
  serviceRequestsAssigned         OperationsServiceRequest[]         @relation("ServiceRequestAssignedTo")
  serviceRequestsCreated          OperationsServiceRequest[]         @relation("ServiceRequestCreatedBy")
  serviceRequestsRequested        OperationsServiceRequest[]         @relation("ServiceRequestRequestedBy")
  serviceRequestsUpdated          OperationsServiceRequest[]         @relation("ServiceRequestUpdatedBy")
  maintenanceCreated             OperationsMaintenance[]            @relation("MaintenanceCreatedBy")
  maintenanceTechnician           OperationsMaintenance[]            @relation("MaintenanceTechnician")
  maintenanceUpdated              OperationsMaintenance[]            @relation("MaintenanceUpdatedBy")
  sessions                       Session[]
  assignedTasks                  Task[]                             @relation("AssignedTasks")
  createdTasks                   Task[]                             @relation("CreatedTasks")
  taskComments                   TaskComment[]
  callParticipants               CallParticipant[]                   @relation("CallParticipants")
  createdCalls                   Call[]                             @relation("CallCreatedBy")
  teamMemberRoles                TeamMember[]
  sentInvitations                TenantInvitation[]                 @relation("InvitedBy")
  tenantAccesses                 UserTenantAccess[]                 @relation("UserTenantAccesses")
  tenantAccessInvitedBy           UserTenantAccess[]                 @relation("TenantAccessInvitedBy")
  timeTrackings                  TimeTracking[]
  timesheets                     Timesheet[]
  createdTutorials               Tutorial[]                         @relation("TutorialCreator")
  orgUnit                        OrgUnit?                           @relation(fields: [orgUnitId], references: [id])
  reportsTo                      User?                              @relation("ReportsTo", fields: [reportsToId], references: [id])
  directReports                  User[]                             @relation("ReportsTo")
  tenant                         Tenant                             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  skills                         UserSkill[]
  workflowAssignments            UserWorkflowAssignment[]

  @@index([email])
  @@index([tenantId])
  @@index([orgUnitId])
  @@index([reportsToId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Tenant {
  id                          String                       @id @default(cuid())
  name                        String
  domain                      String?                      @unique
  logo                        String?
  settings                    Json?
  plan                        String                       @default("free")
  maxUsers                    Int                          @default(10)
  status                      String                       @default("active")
  trialEndsAt                 DateTime?
  ssoEnabled                  Boolean                      @default(false)
  ssoProvider                 SSOProvider?
  ssoConfig                   Json?
  auditLogRetentionDays       Int                          @default(2555)
  taskRetentionDays           Int                          @default(1825)
  notificationRetentionDays   Int                          @default(90)
  projectRetentionDays        Int                          @default(1825)
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  autoJoinEnabled             Boolean                      @default(false)
  codeExpiresAt               DateTime?
  domainVerified              Boolean                      @default(false)
  verificationCode            String?                      @unique
  verificationMethod          String?
  verifiedAt                  DateTime?
  verifiedById                String?
  type                        WorkspaceType                @default(ORGANIZATION)
  accessAuditLogs             AccessAuditLog[]
  activityFeeds               ActivityFeed[]
  annotations                 Annotation[]
  auditLogs                   AuditLog[]
  budgets                     Budget[]
  budgetTransfers             BudgetTransfer[]
  collaborations              Collaboration[]
  clsRules                    ColumnLevelSecurityRule[]
  comments                    Comment[]
  complianceReports           ComplianceReport[]
  dataCatalogEntries          DataCatalogEntry[]
  dataLineage                 DataLineage[]
  dataQualityMetrics          DataQualityMetric[]
  dataRetentionPolicies       DataRetentionPolicy[]
  dataUsage                   DataUsage[]
  defaultLayouts              DefaultLayout[]
  dependencies                Dependency[]
  financialFiles              FinancialFile[]
  functionPermissions         FunctionPermission[]
  grids                       Grid[]                       @relation("Grids")
  integrations                Integration[]
  integrationFieldMappings    IntegrationFieldMapping[]
  integrationSyncJobs         IntegrationSyncJob[]
  integrationSyncLogs         IntegrationSyncLog[]
  integrationTemplateInstalls IntegrationTemplateInstall[]
  integrationTemplateReviews  IntegrationTemplateReview[]
  integrationWebhooks         IntegrationWebhook[]
  invoices                    Invoice[]
  mentions                    Mention[]
  notifications               Notification[]
  oauthTokens                 OAuthToken[]
  orgUnits                    OrgUnit[]
  organizationPermissions     OrganizationPermission[]
  pricingModels               PricingModel[]
  programs                    Program[]
  projects                    Project[]
  quotes                      Quote[]
  rlsCacheEntries             RLSCacheEntry[]
  rateCards                   RateCard[]
  releases                    Release[]
  reminders                   Reminder[]
  reportingActivities         ReportingActivity[]          @relation("ReportingActivities")
  reportingDashboards         ReportingDashboard[]         @relation("ReportingDashboards")
  reportingDataSources        ReportingDataSource[]        @relation("ReportingDataSources")
  reportingDatasets           ReportingDataset[]           @relation("ReportingDatasets")
  reportingFiles              ReportingFile[]
  reportingInsights           ReportingInsight[]           @relation("ReportingInsights")
  reportingQueryCache         ReportingQueryCache[]        @relation("ReportingQueryCache")
  reportingQueryLogs          ReportingQueryLog[]          @relation("ReportingQueryLogs")
  reportingReports            ReportingReport[]            @relation("ReportingReports")
  reportingTemplates          ReportingReportTemplate[]    @relation("ReportingTemplates")
  reportingTransformations    ReportingTransformation[]    @relation("ReportingTransformations")
  userInsightActions          ReportingUserInsightAction[] @relation("UserInsightActions")
  reportingVisualizations     ReportingVisualization[]     @relation("ReportingVisualizations")
  resourceShares              ResourceShare[]
  rlsRules                    RowLevelSecurityRule[]
  // New Reporting System Relations
  dataSources                 DataSource[]                  @relation("DataSourceTenant")
  visualizations              Visualization[]               @relation("VisualizationTenant")
  dashboards                  Dashboard[]                   @relation("DashboardTenant")
  salesAccounts               SalesAccount[]
  salesActivities             SalesActivity[]
  salesAutomationRules        SalesAutomationRule[]
  salesCases                  SalesCase[]
  salesContacts               SalesContact[]
  salesForecasts              SalesForecast[]
  salesLeads                  SalesLead[]
  salesOpportunities          SalesOpportunity[]
  salesOrders                 SalesOrder[]
  salesProducts               SalesProduct[]
  salesQuotes                 SalesQuote[]
  salesQuoteTemplates         SalesQuoteTemplate[]         @relation("SalesQuoteTemplates")
  operationsVendors            OperationsVendor[]           @relation("OperationsVendors")
  operationsServiceRequests   OperationsServiceRequest[]  @relation("OperationsServiceRequests")
  operationsMaintenance        OperationsMaintenance[]     @relation("OperationsMaintenance")
  calls                        Call[]                      @relation("Calls")
  sprints                     Sprint[]
  tasks                       Task[]
  teams                       Team[]
  invitations                 TenantInvitation[]
  tenantAccesses              UserTenantAccess[]                 @relation("TenantAccesses")
  tutorials                   Tutorial[]
  users                       User[]

  @@index([domain])
  @@index([verificationCode])
}

model OrgUnit {
  id                            String                             @id @default(cuid())
  tenantId                      String
  name                          String
  description                   String?
  parentId                      String?
  createdAt                     DateTime                           @default(now())
  updatedAt                     DateTime                           @updatedAt
  clsRules                      ColumnLevelSecurityRule[]          @relation("CLSOrgUnitRules")
  functionPermissions           FunctionPermission[]               @relation("OrgUnitFunctionPermissions")
  parent                        OrgUnit?                           @relation("OrgUnitHierarchy", fields: [parentId], references: [id])
  children                      OrgUnit[]                          @relation("OrgUnitHierarchy")
  tenant                        Tenant                             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organizationPermissions       OrganizationPermission[]           @relation("OrgUnitPermissions")
  permissionInheritanceAsChild  PermissionInheritance[]            @relation("PermissionInheritanceChild")
  permissionInheritanceAsParent PermissionInheritance[]            @relation("PermissionInheritanceParent")
  dashboardPermissions          ReportingDashboardPermission[]     @relation("DashboardOrgUnitPermissions")
  datasetPermissions            ReportingDatasetPermission[]       @relation("DatasetOrgUnitPermissions")
  reportPermissions             ReportingReportPermission[]        @relation("ReportOrgUnitPermissions")
  visualizationPermissions      ReportingVisualizationPermission[] @relation("VisualizationOrgUnitPermissions")
  sharedResources               ResourceShare[]
  rlsRules                      RowLevelSecurityRule[]             @relation("RLSOrgUnitRules")
  users                         User[]

  @@index([tenantId])
  @@index([parentId])
}

model TenantInvitation {
  id          String           @id @default(cuid())
  tenantId    String
  email       String
  token       String           @unique
  role        UserRole         @default(TEAM_MEMBER)
  allowedSections String?                            // JSON array of allowed section names, null = full access
  invitedById String
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  invitedBy   User             @relation("InvitedBy", fields: [invitedById], references: [id])
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userTenantAccesses UserTenantAccess[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@index([status])
}

model UserTenantAccess {
  id            String           @id @default(cuid())
  userId        String
  tenantId      String
  role          UserRole         @default(TEAM_MEMBER)
  groupRole     GroupRole?
  allowedSections String?                            // JSON array of allowed section names, null = full access
  isActive      Boolean          @default(false)      // Primary tenant for the user
  joinedAt      DateTime         @default(now())
  invitedById   String?
  invitationId  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  user          User             @relation("UserTenantAccesses", fields: [userId], references: [id], onDelete: Cascade)
  tenant        Tenant           @relation("TenantAccesses", fields: [tenantId], references: [id], onDelete: Cascade)
  invitedBy     User?            @relation("TenantAccessInvitedBy", fields: [invitedById], references: [id], onDelete: SetNull)
  invitation    TenantInvitation? @relation(fields: [invitationId], references: [id], onDelete: SetNull)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([isActive])
}

model Program {
  id          String        @id @default(cuid())
  tenantId    String
  name        String
  code        String        @unique
  description String?
  startDate   DateTime
  endDate     DateTime
  ownerId     String
  budget      Decimal       @db.Decimal(15, 2)
  status      ProgramStatus @default(PLANNED)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  budgets     Budget[]
  owner       User          @relation("CreatedBy", fields: [ownerId], references: [id])
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects    Project[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([code])
}

model Project {
  id              String           @id @default(cuid())
  tenantId        String
  programId       String?
  name            String
  code            String           @unique
  description     String?
  startDate       DateTime
  endDate         DateTime
  managerId       String
  createdById     String
  status          ProjectStatus    @default(PLANNED)
  ragStatus       RAGStatus        @default(GREEN)
  progress        Int              @default(0)
  budget          Json
  initiateData    Json?
  planningData    Json?
  executionData   Json?
  closureData     Json?
  deletedAt       DateTime?
  deletedById     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  methodologyType MethodologyType?
  workflowType    WorkflowType?
  budgets         Budget[]
  changeRequests  ChangeRequest[]
  collaborations  Collaboration[]
  costActuals     CostActual[]
  forecasts       Forecast[]
  invoices        Invoice[]
  issues          Issue[]
  pricingModels   PricingModel[]
  createdBy       User             @relation("CreatedBy", fields: [createdById], references: [id])
  manager         User             @relation("ProjectManager", fields: [managerId], references: [id])
  program         Program?         @relation(fields: [programId], references: [id])
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  teamMembers     ProjectMember[]
  quotes          Quote[]
  releases        Release[]
  risks           Risk[]
  sprints         Sprint[]
  tasks           Task[]
  timesheets      Timesheet[]

  @@index([tenantId])
  @@index([programId])
  @@index([managerId])
  @@index([code])
  @@index([deletedAt])
}

model ProjectMember {
  id         String    @id @default(cuid())
  projectId  String
  userId     String
  role       String
  allocation Int       @default(100)
  joinedAt   DateTime  @default(now())
  leftAt     DateTime?
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Task {
  id             String          @id @default(cuid())
  tenantId       String
  projectId      String?
  title          String
  description    String?
  assigneeId     String?
  createdById    String
  status         TaskStatus      @default(TODO)
  priority       Priority        @default(MEDIUM)
  dueDate        DateTime?
  startDate      DateTime?
  completedAt    DateTime?
  estimatedHours Decimal?        @db.Decimal(8, 2)
  actualHours    Decimal?        @db.Decimal(8, 2)
  tags           String[]
  sourceType     String?
  sourceId       String?
  parentId       String?
  deletedAt      DateTime?
  deletedById    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  releaseId      String?
  sprintId       String?
  collaborations Collaboration[]
  costActuals    CostActual[]
  assignee       User?           @relation("AssignedTasks", fields: [assigneeId], references: [id])
  createdBy      User            @relation("CreatedTasks", fields: [createdById], references: [id])
  parent         Task?           @relation("TaskHierarchy", fields: [parentId], references: [id])
  subtasks       Task[]          @relation("TaskHierarchy")
  project        Project?        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  release        Release?        @relation(fields: [releaseId], references: [id])
  sprint         Sprint?         @relation(fields: [sprintId], references: [id])
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  comments       TaskComment[]
  timeTrackings  TimeTracking[]

  @@index([tenantId])
  @@index([projectId])
  @@index([sprintId])
  @@index([releaseId])
  @@index([assigneeId])
  @@index([createdById])
  @@index([parentId])
  @@index([deletedAt])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
}

model TimeTracking {
  id        String    @id @default(cuid())
  taskId    String
  userId    String
  startTime DateTime
  endTime   DateTime?
  duration  Int?
  date      DateTime  @default(now()) @db.Date
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@index([date])
}

model TaskTemplate {
  id              String           @id @default(cuid())
  workflowType    WorkflowType
  methodologyType MethodologyType?
  name            String
  description     String?
  category        String?
  fields          Json
  defaultStatus   TaskStatus?
  defaultPriority Priority?
  workflowFields  Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([workflowType, methodologyType])
}

model RequirementTemplate {
  id              String           @id @default(cuid())
  workflowType    WorkflowType
  methodologyType MethodologyType?
  name            String
  description     String?
  sections        Json
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([workflowType, methodologyType])
}

model UserWorkflowAssignment {
  id           String       @id @default(cuid())
  userId       String
  workflowType WorkflowType
  assignedBy   String?
  assignedAt   DateTime     @default(now())
  isActive     Boolean      @default(true)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workflowType])
  @@index([userId])
}

model Risk {
  id             String          @id @default(cuid())
  projectId      String
  title          String
  description    String
  category       String
  probability    RiskProbability
  impact         RiskImpact
  level          RiskLevel
  mitigation     String?
  contingency    String?
  ownerId        String
  status         RiskStatus      @default(IDENTIFIED)
  identifiedDate DateTime        @default(now())
  reviewDate     DateTime?
  closedDate     DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Issue {
  id           String        @id @default(cuid())
  projectId    String
  title        String
  description  String
  category     String
  priority     Priority
  severity     IssueSeverity
  resolution   String?
  status       IssueStatus   @default(OPEN)
  reportedDate DateTime      @default(now())
  resolvedDate DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ChangeRequest {
  id              String              @id @default(cuid())
  projectId       String
  title           String
  description     String
  category        String
  justification   String
  impact          Json
  priority        Priority
  status          ChangeRequestStatus @default(DRAFT)
  requestedBy     String
  requestedDate   DateTime            @default(now())
  approvedBy      String?
  approvedDate    DateTime?
  implementedDate DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Goal {
  id          String      @id @default(cuid())
  tenantId    String
  title       String
  description String?
  level       GoalLevel   @default(TEAM)
  quarter     String
  year        Int
  ownerId     String
  status      GoalStatus  @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  keyResults  KeyResult[]

  @@index([tenantId])
  @@index([ownerId])
}

model KeyResult {
  id           String      @id @default(cuid())
  goalId       String
  title        String
  description  String?
  startValue   Decimal     @db.Decimal(15, 2)
  targetValue  Decimal     @db.Decimal(15, 2)
  currentValue Decimal     @db.Decimal(15, 2)
  unit         String
  weight       Int         @default(25)
  confidence   Int         @default(5)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  checkIns     KRCheckIn[]
  goal         Goal        @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
}

model KRCheckIn {
  id          String    @id @default(cuid())
  keyResultId String
  value       Decimal   @db.Decimal(15, 2)
  confidence  Int
  narrative   String?
  createdById String
  createdAt   DateTime  @default(now())
  keyResult   KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)

  @@index([keyResultId])
  @@index([createdAt])
}

model Timesheet {
  id          String          @id @default(cuid())
  userId      String
  projectId   String
  date        DateTime
  hours       Decimal         @db.Decimal(5, 2)
  description String?
  billable    Boolean         @default(true)
  status      TimesheetStatus @default(DRAFT)
  submittedAt DateTime?
  approvedAt  DateTime?
  approvedBy  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([date])
}

model Approval {
  id            String             @id @default(cuid())
  tenantId      String
  type          ApprovalType
  title         String
  description   String?
  entityId      String?
  entityType    String?
  documentData  Json?
  requestedById String
  requestedAt   DateTime           @default(now())
  ccList        String[]
  message       String?
  status        ApprovalStatus     @default(PENDING)
  approvedAt    DateTime?
  approvedById  String?
  rejectedAt    DateTime?
  rejectedById  String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  approvedBy    User?              @relation("ApprovalFinalApprover", fields: [approvedById], references: [id])
  rejectedBy    User?              @relation("ApprovalFinalRejecter", fields: [rejectedById], references: [id])
  requestedBy   User               @relation("ApprovalRequester", fields: [requestedById], references: [id])
  approvers     ApprovalApprover[]

  @@index([tenantId])
  @@index([requestedById])
  @@index([status])
  @@index([entityId])
}

model ApprovalApprover {
  id         String         @id @default(cuid())
  approvalId String
  userId     String
  status     ApprovalStatus @default(PENDING)
  approvedAt DateTime?
  rejectedAt DateTime?
  comments   String?
  notifiedAt DateTime?
  viewedAt   DateTime?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  approval   Approval       @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  user       User           @relation(fields: [userId], references: [id])

  @@unique([approvalId, userId])
  @@index([approvalId])
  @@index([userId])
  @@index([status])
}

model Skill {
  id         String      @id @default(cuid())
  name       String      @unique
  category   String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  userSkills UserSkill[]
}

model UserSkill {
  id                String     @id @default(cuid())
  userId            String
  skillId           String
  level             SkillLevel
  yearsOfExperience Decimal?   @db.Decimal(4, 1)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  skill             Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
}

model Notification {
  id         String               @id @default(cuid())
  userId     String
  tenantId   String
  type       NotificationType
  title      String
  message    String
  entityType String?
  entityId   String?
  read       Boolean              @default(false)
  priority   NotificationPriority @default(MEDIUM)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  tenant     Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User                 @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([tenantId])
  @@index([createdAt])
}

model Reminder {
  id          String   @id @default(cuid())
  tenantId    String
  createdById String
  userId      String
  title       String
  description String?
  remindAt    DateTime
  sourceType  String?
  sourceId    String?
  completed   Boolean  @default(false)
  dismissed   Boolean  @default(false)
  notified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation("CreatedReminders", fields: [createdById], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation("UserReminders", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, remindAt, completed])
  @@index([tenantId])
  @@index([createdById])
}

model AuditLog {
  id         String      @id @default(cuid())
  tenantId   String
  userId     String
  action     AuditAction
  entity     AuditEntity
  entityId   String?
  entityName String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime    @default(now())
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User        @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
}

model Tutorial {
  id          String          @id @default(cuid())
  tenantId    String
  title       String
  description String
  type        TutorialType
  duration    String
  level       TutorialLevel
  category    String
  section     TutorialSection
  videoUrl    String?
  contentText String?
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  thumbnail   String?
  order       Int             @default(0)
  isPublished Boolean         @default(true)
  viewCount   Int             @default(0)
  createdById String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdBy   User            @relation("TutorialCreator", fields: [createdById], references: [id])
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([section, category])
  @@index([isPublished])
  @@index([order])
}

model Collaboration {
  id          String                    @id @default(cuid())
  tenantId    String
  name        String
  description String?
  type        CollaborationType
  projectId   String?
  taskId      String?
  createdById String
  status      CollaborationStatus       @default(ACTIVE)
  isArchived  Boolean                   @default(false)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  createdBy   User                      @relation("CollaborationCreator", fields: [createdById], references: [id])
  project     Project?                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?                     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tenant      Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  files       CollaborationFile[]
  members     CollaborationMember[]
  messages    CollaborationMessage[]
  suggestions CollaborationSuggestion[]

  @@index([tenantId])
  @@index([projectId])
  @@index([taskId])
  @@index([createdById])
  @@index([status])
}

model CollaborationMember {
  id              String            @id @default(cuid())
  collaborationId String
  userId          String
  role            CollaborationRole @default(MEMBER)
  canEdit         Boolean           @default(false)
  canInvite       Boolean           @default(false)
  canDelete       Boolean           @default(false)
  joinedAt        DateTime          @default(now())
  lastSeenAt      DateTime?
  collaboration   Collaboration     @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([collaborationId, userId])
  @@index([collaborationId])
  @@index([userId])
}

model CollaborationMessage {
  id              String                 @id @default(cuid())
  collaborationId String
  userId          String
  content         String
  mentions        String[]
  parentId        String?
  isEdited        Boolean                @default(false)
  isDeleted       Boolean                @default(false)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  reactions       Json?
  collaboration   Collaboration          @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  parent          CollaborationMessage?  @relation("MessageReplies", fields: [parentId], references: [id])
  replies         CollaborationMessage[] @relation("MessageReplies")
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([collaborationId])
  @@index([userId])
  @@index([parentId])
}

model CollaborationFile {
  id              String        @id @default(cuid())
  collaborationId String
  userId          String
  fileName        String
  fileUrl         String
  fileSize        Int
  fileType        String
  description     String?
  uploadedAt      DateTime      @default(now())
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([collaborationId])
  @@index([userId])
}

model CollaborationSuggestion {
  id               String           @id @default(cuid())
  collaborationId  String
  userId           String
  title            String
  description      String
  suggestionType   SuggestionType
  targetType       String?
  targetId         String?
  originalContent  String?
  suggestedContent String?
  status           SuggestionStatus @default(PENDING)
  respondedById    String?
  responseNote     String?
  respondedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  collaboration    Collaboration    @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  respondedBy      User?            @relation("SuggestionResponder", fields: [respondedById], references: [id])
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([collaborationId])
  @@index([userId])
  @@index([status])
}

model DefaultLayout {
  id          String    @id @default(cuid())
  tenantId    String
  pageKey     String
  targetRole  UserRole?
  layoutData  Json
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   User      @relation(fields: [createdById], references: [id])
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, pageKey, targetRole])
  @@index([tenantId, pageKey])
  @@index([createdById])
}

model ReportingFile {
  id           String   @id @default(cuid())
  name         String
  originalName String
  filePath     String
  size         Int
  type         String
  rowCount     Int?
  columnCount  Int?
  uploadedBy   String
  tenantId     String
  uploadedAt   DateTime @default(now())
  updatedAt    DateTime @updatedAt
  isMerged     Boolean  @default(false)
  mergeConfig  Json?
  sourceFiles  String[] @default([])
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploader     User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([uploadedBy])
  @@index([uploadedAt])
}

model ReportingDashboard {
  id            String                         @id @default(cuid())
  name          String
  description   String?
  configuration Json
  createdBy     String
  updatedBy     String
  deletedAt     DateTime?
  createdAt     DateTime                       @default(now())
  updatedAt     DateTime                       @updatedAt
  tenantId      String
  createdByUser User                           @relation("DashboardCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  tenant        Tenant                         @relation("ReportingDashboards", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedByUser User                           @relation("DashboardUpdatedBy", fields: [updatedBy], references: [id], onDelete: Cascade)
  datasets      ReportingDashboardDataset[]    @relation("DashboardDatasets")
  permissions   ReportingDashboardPermission[] @relation("DashboardPermissions")
  widgets       ReportingDashboardWidget[]     @relation("DashboardWidgets")
  reports       ReportingReport[]              @relation("DashboardReports")

  @@index([tenantId])
  @@index([createdBy])
  @@index([updatedBy])
  @@index([createdAt])
  @@index([deletedAt])
}

model Release {
  id          String        @id @default(cuid())
  tenantId    String
  projectId   String?
  name        String
  version     String
  description String?
  status      ReleaseStatus @default(PLANNED)
  releaseDate DateTime?
  targetDate  DateTime
  progress    Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  project     Project?      @relation(fields: [projectId], references: [id])
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@index([targetDate])
}

model Sprint {
  id          String       @id @default(cuid())
  tenantId    String
  projectId   String
  name        String
  goal        String
  description String?
  status      SprintStatus @default(PLANNED)
  startDate   DateTime
  endDate     DateTime
  progress    Int          @default(0)
  storyPoints Int          @default(0)
  velocity    Int?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([tenantId])
  @@index([projectId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model Dependency {
  id          String           @id @default(cuid())
  tenantId    String
  name        String
  description String?
  type        DependencyType
  status      DependencyStatus @default(ACTIVE)
  priority    Priority         @default(MEDIUM)
  impact      String
  mitigation  String?
  sourceType  String
  sourceId    String
  targetType  String
  targetId    String
  resolvedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@index([status])
  @@index([priority])
}

model Team {
  id          String       @id @default(cuid())
  tenantId    String
  name        String
  description String?
  department  String?
  status      TeamStatus   @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members     TeamMember[]

  @@index([tenantId])
  @@index([status])
  @@index([department])
}

model TeamMember {
  id       String    @id @default(cuid())
  teamId   String
  userId   String
  role     String
  joinedAt DateTime  @default(now())
  leftAt   DateTime?
  team     Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Budget {
  id             String           @id @default(cuid())
  tenantId       String
  projectId      String?
  programId      String?
  portfolioId    String?
  name           String
  description    String?
  fiscalYear     Int
  fiscalQuarter  Int?
  version        String           @default("baseline")
  status         BudgetStatus     @default(DRAFT)
  totalAmount    Decimal          @db.Decimal(15, 2)
  currency       String           @default("USD")
  startDate      DateTime
  endDate        DateTime
  approvedBy     String?
  approvedAt     DateTime?
  lockedAt       DateTime?
  createdById    String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  approvedByUser User?            @relation("BudgetApprover", fields: [approvedBy], references: [id])
  createdBy      User             @relation("BudgetCreator", fields: [createdById], references: [id])
  program        Program?         @relation(fields: [programId], references: [id])
  project        Project?         @relation(fields: [projectId], references: [id])
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  approvals      BudgetApproval[]
  categories     BudgetCategory[]
  lineItems      BudgetLineItem[]
  transfersFrom  BudgetTransfer[] @relation("BudgetTransfersFrom")
  transfersTo    BudgetTransfer[] @relation("BudgetTransfersTo")
  actuals        CostActual[]
  forecasts      Forecast[]

  @@index([tenantId])
  @@index([projectId])
  @@index([programId])
  @@index([fiscalYear])
  @@index([status])
}

model BudgetCategory {
  id               String           @id @default(cuid())
  budgetId         String
  name             String
  code             String?
  allocatedAmount  Decimal          @db.Decimal(15, 2)
  spentAmount      Decimal          @default(0) @db.Decimal(15, 2)
  committedAmount  Decimal          @default(0) @db.Decimal(15, 2)
  forecastAmount   Decimal?         @db.Decimal(15, 2)
  variance         Decimal          @default(0) @db.Decimal(15, 2)
  percentage       Decimal          @default(0) @db.Decimal(5, 2)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  level            Int              @default(1)
  parentCategoryId String?
  budget           Budget           @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  parentCategory   BudgetCategory?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id], onDelete: Cascade)
  subCategories    BudgetCategory[] @relation("CategoryHierarchy")
  lineItems        BudgetLineItem[]
  actuals          CostActual[]

  @@index([budgetId])
  @@index([parentCategoryId])
}

model BudgetLineItem {
  id              String          @id @default(cuid())
  budgetId        String
  categoryId      String?
  name            String
  description     String?
  quantity        Decimal?        @db.Decimal(10, 2)
  unitPrice       Decimal?        @db.Decimal(15, 2)
  totalAmount     Decimal         @db.Decimal(15, 2)
  allocatedAmount Decimal         @default(0) @db.Decimal(15, 2)
  spentAmount     Decimal         @default(0) @db.Decimal(15, 2)
  committedAmount Decimal         @default(0) @db.Decimal(15, 2)
  forecastAmount  Decimal?        @db.Decimal(15, 2)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  budget          Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category        BudgetCategory? @relation(fields: [categoryId], references: [id])

  @@index([budgetId])
  @@index([categoryId])
}

model BudgetTransfer {
  id              String         @id @default(cuid())
  tenantId        String
  fromBudgetId    String
  toBudgetId      String
  fromCategoryId  String?
  toCategoryId    String?
  amount          Decimal        @db.Decimal(15, 2)
  reason          String
  status          TransferStatus @default(PENDING)
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  executedAt      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  approvedByUser  User?          @relation("TransferApprover", fields: [approvedBy], references: [id])
  fromBudget      Budget         @relation("BudgetTransfersFrom", fields: [fromBudgetId], references: [id])
  requestedByUser User           @relation("TransferRequester", fields: [requestedBy], references: [id])
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  toBudget        Budget         @relation("BudgetTransfersTo", fields: [toBudgetId], references: [id])

  @@index([tenantId])
  @@index([fromBudgetId])
  @@index([toBudgetId])
  @@index([status])
}

model BudgetApproval {
  id         String         @id @default(cuid())
  budgetId   String
  approverId String
  level      Int
  status     ApprovalStatus @default(PENDING)
  comments   String?
  approvedAt DateTime?
  createdAt  DateTime       @default(now())
  approver   User           @relation("BudgetApprovals", fields: [approverId], references: [id])
  budget     Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([approverId])
  @@index([status])
}

model Forecast {
  id               String              @id @default(cuid())
  budgetId         String
  projectId        String?
  name             String
  description      String?
  forecastType     ForecastType        @default(AI_POWERED)
  scenario         ScenarioType?
  model            ForecastModel       @default(LINEAR)
  forecastedAmount Decimal             @db.Decimal(15, 2)
  confidence       Int
  confidenceLow    Decimal?            @db.Decimal(15, 2)
  confidenceHigh   Decimal?            @db.Decimal(15, 2)
  assumptions      Json?
  accuracy         Decimal?            @db.Decimal(5, 2)
  generatedBy      String?
  generatedAt      DateTime            @default(now())
  validUntil       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  budget           Budget              @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  project          Project?            @relation(fields: [projectId], references: [id])
  dataPoints       ForecastDataPoint[]

  @@index([budgetId])
  @@index([projectId])
  @@index([forecastType])
  @@index([generatedAt])
}

model ForecastDataPoint {
  id         String   @id @default(cuid())
  forecastId String
  date       DateTime
  amount     Decimal  @db.Decimal(15, 2)
  confidence Int?
  notes      String?
  createdAt  DateTime @default(now())
  forecast   Forecast @relation(fields: [forecastId], references: [id], onDelete: Cascade)

  @@index([forecastId])
  @@index([date])
}

model CostActual {
  id               String          @id @default(cuid())
  budgetId         String
  budgetCategoryId String?
  projectId        String?
  taskId           String?
  costCenter       String?
  name             String
  description      String?
  amount           Decimal         @db.Decimal(15, 2)
  currency         String          @default("USD")
  costType         CostType        @default(DIRECT)
  source           CostSource      @default(MANUAL)
  sourceId         String?
  invoiceId        String?
  date             DateTime
  approvedBy       String?
  approvedAt       DateTime?
  createdById      String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  approvedByUser   User?           @relation("CostApprover", fields: [approvedBy], references: [id])
  category         BudgetCategory? @relation(fields: [budgetCategoryId], references: [id])
  budget           Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  createdBy        User            @relation("CostCreator", fields: [createdById], references: [id])
  invoice          Invoice?        @relation(fields: [invoiceId], references: [id])
  project          Project?        @relation(fields: [projectId], references: [id])
  task             Task?           @relation(fields: [taskId], references: [id])

  @@index([budgetId])
  @@index([projectId])
  @@index([date])
  @@index([source])
  @@index([costType])
}

model RateCard {
  id            String         @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  effectiveDate DateTime
  expiryDate    DateTime?
  isDefault     Boolean        @default(false)
  currency      String         @default("USD")
  status        RateCardStatus @default(ACTIVE)
  createdById   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     User           @relation("RateCardCreator", fields: [createdById], references: [id])
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rates         RateCardItem[]

  @@index([tenantId])
  @@index([status])
  @@index([effectiveDate])
}

model RateCardItem {
  id            String    @id @default(cuid())
  rateCardId    String
  role          String
  region        String?
  costRate      Decimal   @db.Decimal(10, 2)
  billableRate  Decimal   @db.Decimal(10, 2)
  currency      String    @default("USD")
  effectiveDate DateTime
  expiryDate    DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  rateCard      RateCard  @relation(fields: [rateCardId], references: [id], onDelete: Cascade)

  @@index([rateCardId])
  @@index([role])
  @@index([region])
}

model PricingModel {
  id               String            @id @default(cuid())
  tenantId         String
  projectId        String?
  name             String
  description      String?
  pricingType      PricingType
  baseAmount       Decimal?          @db.Decimal(15, 2)
  markupPercentage Decimal?          @db.Decimal(5, 2)
  currency         String            @default("USD")
  status           PricingStatus     @default(DRAFT)
  approvedBy       String?
  approvedAt       DateTime?
  createdById      String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  lineItems        PricingLineItem[]
  approvedByUser   User?             @relation("PricingApprover", fields: [approvedBy], references: [id])
  createdBy        User              @relation("PricingCreator", fields: [createdById], references: [id])
  project          Project?          @relation(fields: [projectId], references: [id])
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quotes           Quote[]

  @@index([tenantId])
  @@index([projectId])
  @@index([pricingType])
  @@index([status])
}

model PricingLineItem {
  id             String       @id @default(cuid())
  pricingModelId String
  name           String
  description    String?
  quantity       Decimal?     @db.Decimal(10, 2)
  unitPrice      Decimal      @db.Decimal(15, 2)
  totalPrice     Decimal      @db.Decimal(15, 2)
  category       String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  pricingModel   PricingModel @relation(fields: [pricingModelId], references: [id], onDelete: Cascade)

  @@index([pricingModelId])
}

model Quote {
  id             String          @id @default(cuid())
  tenantId       String
  projectId      String?
  pricingModelId String
  quoteNumber    String          @unique
  clientName     String
  clientEmail    String?
  subject        String
  description    String?
  totalAmount    Decimal         @db.Decimal(15, 2)
  currency       String          @default("USD")
  taxAmount      Decimal         @default(0) @db.Decimal(15, 2)
  taxRate        Decimal         @default(0) @db.Decimal(5, 2)
  validUntil     DateTime?
  status         QuoteStatus     @default(DRAFT)
  sentAt         DateTime?
  acceptedAt     DateTime?
  rejectedAt     DateTime?
  createdById    String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  invoices       Invoice[]
  createdBy      User            @relation("QuoteCreator", fields: [createdById], references: [id])
  pricingModel   PricingModel    @relation(fields: [pricingModelId], references: [id])
  project        Project?        @relation(fields: [projectId], references: [id])
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lineItems      QuoteLineItem[]

  @@index([tenantId])
  @@index([projectId])
  @@index([quoteNumber])
  @@index([status])
}

model QuoteLineItem {
  id          String   @id @default(cuid())
  quoteId     String
  name        String
  description String?
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2)
  totalPrice  Decimal  @db.Decimal(15, 2)
  createdAt   DateTime @default(now())
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Invoice {
  id               String            @id @default(cuid())
  tenantId         String
  projectId        String?
  quoteId          String?
  invoiceNumber    String            @unique
  clientName       String
  clientEmail      String?
  clientAddress    Json?
  billingAddress   Json?
  subject          String
  description      String?
  invoiceDate      DateTime
  dueDate          DateTime
  subtotal         Decimal           @db.Decimal(15, 2)
  taxAmount        Decimal           @default(0) @db.Decimal(15, 2)
  taxRate          Decimal           @default(0) @db.Decimal(5, 2)
  discount         Decimal           @default(0) @db.Decimal(15, 2)
  totalAmount      Decimal           @db.Decimal(15, 2)
  currency         String            @default("USD")
  status           InvoiceStatus     @default(DRAFT)
  paymentStatus    PaymentStatus     @default(UNPAID)
  paymentDate      DateTime?
  paymentMethod    String?
  paymentReference String?
  sentAt           DateTime?
  paidAt           DateTime?
  overdueAt        DateTime?
  notes            String?
  terms            String?
  createdById      String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  costs            CostActual[]
  createdBy        User              @relation("InvoiceCreator", fields: [createdById], references: [id])
  project          Project?          @relation(fields: [projectId], references: [id])
  quote            Quote?            @relation(fields: [quoteId], references: [id])
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lineItems        InvoiceLineItem[]
  payments         InvoicePayment[]

  @@index([tenantId])
  @@index([projectId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([dueDate])
}

model InvoiceLineItem {
  id          String   @id @default(cuid())
  invoiceId   String
  name        String
  description String?
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2)
  totalPrice  Decimal  @db.Decimal(15, 2)
  timesheetId String?
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoicePayment {
  id               String   @id @default(cuid())
  invoiceId        String
  amount           Decimal  @db.Decimal(15, 2)
  paymentDate      DateTime
  paymentMethod    String
  paymentReference String?
  notes            String?
  createdById      String
  createdAt        DateTime @default(now())
  createdBy        User     @relation("PaymentCreator", fields: [createdById], references: [id])
  invoice          Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentDate])
}

model FinancialFile {
  id                String         @id @default(cuid())
  tenantId          String
  fileName          String
  originalFileName  String
  fileType          String
  fileSize          Int
  filePath          String
  uploadType        FileUploadType
  status            FileStatus     @default(PENDING)
  processedAt       DateTime?
  processedBy       String?
  errorMessage      String?
  recordCount       Int?
  successCount      Int?
  failureCount      Int?
  mappingConfig     Json?
  validationResults Json?
  createdById       String
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  createdBy         User           @relation("FinancialFileCreator", fields: [createdById], references: [id])
  processedByUser   User?          @relation("FinancialFileProcessor", fields: [processedBy], references: [id])
  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([uploadType])
  @@index([status])
  @@index([createdAt])
}

model SalesAccount {
  id                String             @id @default(cuid())
  tenantId          String
  name              String
  type              AccountType        @default(CUSTOMER)
  industry          String?
  website           String?
  phone             String?
  email             String?
  billingAddress    Json?
  shippingAddress   Json?
  annualRevenue     Decimal?           @db.Decimal(15, 2)
  numberOfEmployees Int?
  description       String?
  ownerId           String
  parentAccountId   String?
  status            AccountStatus      @default(ACTIVE)
  rating            AccountRating?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  owner             User               @relation("AccountOwner", fields: [ownerId], references: [id])
  parentAccount     SalesAccount?      @relation("AccountHierarchy", fields: [parentAccountId], references: [id])
  childAccounts     SalesAccount[]     @relation("AccountHierarchy")
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  activities        SalesActivity[]
  cases             SalesCase[]
  contacts          SalesContact[]
  forecasts         SalesForecast[]
  opportunities     SalesOpportunity[]
  orders            SalesOrder[]
  quotes            SalesQuote[]

  @@index([tenantId])
  @@index([ownerId])
  @@index([parentAccountId])
  @@index([status])
  @@index([type])
}

model SalesContact {
  id                  String                    @id @default(cuid())
  tenantId            String
  accountId           String?
  firstName           String
  lastName            String
  email               String?
  phone               String?
  mobile              String?
  title               String?
  department          String?
  mailingAddress      Json?
  description         String?
  ownerId             String
  reportsToId         String?
  convertedFromLeadId String?                   @unique
  status              ContactStatus             @default(ACTIVE)
  leadSource          LeadSource?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  activities          SalesActivity[]
  cases               SalesCase[]
  account             SalesAccount?             @relation(fields: [accountId], references: [id])
  convertedFromLead   SalesLead?                @relation("LeadToContact", fields: [convertedFromLeadId], references: [id])
  owner               User                      @relation("ContactOwner", fields: [ownerId], references: [id])
  reportsTo           SalesContact?             @relation("ContactHierarchy", fields: [reportsToId], references: [id])
  directReports       SalesContact[]            @relation("ContactHierarchy")
  tenant              Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  opportunities       SalesOpportunityContact[]

  @@index([tenantId])
  @@index([accountId])
  @@index([ownerId])
  @@index([email])
  @@index([status])
}

model SalesLead {
  id                     String            @id @default(cuid())
  tenantId               String
  firstName              String
  lastName               String
  company                String?
  email                  String
  phone                  String?
  mobile                 String?
  title                  String?
  industry               String?
  leadSource             LeadSource
  status                 LeadStatus        @default(NEW)
  rating                 LeadRating        @default(COLD)
  score                  Int               @default(0)
  description            String?
  assignedToId           String?
  convertedAt            DateTime?
  ownerId                String
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  customFields           Json?
  nextContactDate        DateTime?
  activities             SalesActivity[]
  convertedToContact     SalesContact?     @relation("LeadToContact")
  assignedTo             User?             @relation("LeadAssignedTo", fields: [assignedToId], references: [id])
  owner                  User              @relation("LeadOwner", fields: [ownerId], references: [id])
  tenant                 Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  convertedToOpportunity SalesOpportunity? @relation("LeadToOpportunity")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([assignedToId])
  @@index([ownerId])
  @@index([status])
  @@index([leadSource])
  @@index([email])
}

model SalesOpportunity {
  id                  String                    @id @default(cuid())
  tenantId            String
  accountId           String?
  name                String
  description         String?
  stage               OpportunityStage          @default(PROSPECTING)
  amount              Decimal                   @db.Decimal(15, 2)
  probability         Int                       @default(10)
  expectedCloseDate   DateTime
  actualCloseDate     DateTime?
  type                OpportunityType?
  leadSource          LeadSource?
  nextStep            String?
  competitorInfo      String?
  lossReason          String?
  ownerId             String
  createdById         String
  status              OpportunityStatus         @default(OPEN)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  convertedFromLeadId String?                   @unique
  activities          SalesActivity[]
  account             SalesAccount?             @relation(fields: [accountId], references: [id])
  convertedFromLead   SalesLead?                @relation("LeadToOpportunity", fields: [convertedFromLeadId], references: [id])
  createdBy           User                      @relation("OpportunityCreatedBy", fields: [createdById], references: [id])
  owner               User                      @relation("OpportunityOwner", fields: [ownerId], references: [id])
  tenant              Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts            SalesOpportunityContact[]
  products            SalesOpportunityProduct[]
  orders              SalesOrder[]
  quotes              SalesQuote[]

  @@index([tenantId])
  @@index([accountId])
  @@index([ownerId])
  @@index([stage])
  @@index([status])
  @@index([expectedCloseDate])
}

model SalesOpportunityContact {
  id            String           @id @default(cuid())
  opportunityId String
  contactId     String
  role          ContactRole
  isPrimary     Boolean          @default(false)
  createdAt     DateTime         @default(now())
  contact       SalesContact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  opportunity   SalesOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, contactId])
  @@index([opportunityId])
  @@index([contactId])
}

model SalesProduct {
  id                  String                    @id @default(cuid())
  tenantId            String
  name                String
  code                String
  description         String?
  family              String?
  category            String?
  unitPrice           Decimal                   @db.Decimal(15, 2)
  cost                Decimal?                  @db.Decimal(15, 2)
  isActive            Boolean                   @default(true)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  opportunityProducts SalesOpportunityProduct[]
  orderLineItems      SalesOrderLineItem[]
  tenant              Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quoteLineItems      SalesQuoteLineItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
}

model SalesOpportunityProduct {
  id            String           @id @default(cuid())
  opportunityId String
  productId     String
  quantity      Decimal          @db.Decimal(10, 2)
  unitPrice     Decimal          @db.Decimal(15, 2)
  discount      Decimal          @default(0) @db.Decimal(5, 2)
  totalPrice    Decimal          @db.Decimal(15, 2)
  description   String?
  createdAt     DateTime         @default(now())
  opportunity   SalesOpportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  product       SalesProduct     @relation(fields: [productId], references: [id])

  @@index([opportunityId])
  @@index([productId])
}

model SalesActivity {
  id            String            @id @default(cuid())
  tenantId      String
  type          ActivityType
  subject       String
  description   String?
  status        ActivityStatus    @default(PLANNED)
  priority      Priority          @default(MEDIUM)
  dueDate       DateTime?
  completedDate DateTime?
  duration      Int?
  location      String?
  accountId     String?
  contactId     String?
  leadId        String?
  opportunityId String?
  assignedToId  String
  createdById   String
  relatedToType String?
  relatedToId   String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  account       SalesAccount?     @relation(fields: [accountId], references: [id])
  assignedTo    User              @relation("ActivityAssignedTo", fields: [assignedToId], references: [id])
  contact       SalesContact?     @relation(fields: [contactId], references: [id])
  createdBy     User              @relation("ActivityCreatedBy", fields: [createdById], references: [id])
  lead          SalesLead?        @relation(fields: [leadId], references: [id])
  opportunity   SalesOpportunity? @relation(fields: [opportunityId], references: [id])
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([accountId])
  @@index([contactId])
  @@index([leadId])
  @@index([opportunityId])
  @@index([assignedToId])
  @@index([type])
  @@index([status])
  @@index([dueDate])
}

model SalesQuote {
  id               String               @id @default(cuid())
  tenantId         String
  accountId        String?
  opportunityId    String?
  quoteNumber      String               @unique
  name             String
  description      String?
  status           QuoteStatus          @default(DRAFT)
  validUntil       DateTime?
  subtotal         Decimal              @db.Decimal(15, 2)
  taxAmount        Decimal              @default(0) @db.Decimal(15, 2)
  taxRate          Decimal              @default(0) @db.Decimal(5, 2)
  discount         Decimal              @default(0) @db.Decimal(15, 2)
  discountType     DiscountType         @default(AMOUNT)
  totalAmount      Decimal              @db.Decimal(15, 2)
  currency         String               @default("USD")
  terms            String?
  notes            String?
  sentAt           DateTime?
  acceptedAt       DateTime?
  rejectedAt       DateTime?
  createdById      String
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  requiresApproval Boolean              @default(false)
  approvedById     String?
  approvedAt       DateTime?
  approvalNotes    String?
  versionNumber    Int                  @default(1)
  parentQuoteId    String?
  signatureData    Json?
  signedByName     String?
  signedByEmail    String?
  signedAt         DateTime?
  templateId       String?
  orders           SalesOrder[]
  account          SalesAccount?        @relation(fields: [accountId], references: [id])
  approvedBy       User?                @relation("QuoteApprovedBy", fields: [approvedById], references: [id])
  createdBy        User                 @relation("QuoteCreatedBy", fields: [createdById], references: [id])
  opportunity      SalesOpportunity?    @relation(fields: [opportunityId], references: [id])
  parentQuote      SalesQuote?          @relation("QuoteVersions", fields: [parentQuoteId], references: [id])
  versions         SalesQuote[]         @relation("QuoteVersions")
  tenant           Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lineItems        SalesQuoteLineItem[]

  @@index([tenantId])
  @@index([accountId])
  @@index([opportunityId])
  @@index([quoteNumber])
  @@index([status])
  @@index([parentQuoteId])
  @@index([versionNumber])
}

model SalesQuoteTemplate {
  id           String   @id @default(cuid())
  tenantId     String
  name         String
  description  String?
  templateData Json
  isDefault    Boolean  @default(false)
  createdById  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    User     @relation("QuoteTemplateCreatedBy", fields: [createdById], references: [id])
  tenant       Tenant   @relation("SalesQuoteTemplates", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdById])
}

model SalesQuoteLineItem {
  id          String        @id @default(cuid())
  quoteId     String
  productId   String?
  name        String
  description String?
  quantity    Decimal       @db.Decimal(10, 2)
  unitPrice   Decimal       @db.Decimal(15, 2)
  discount    Decimal       @default(0) @db.Decimal(5, 2)
  totalPrice  Decimal       @db.Decimal(15, 2)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  product     SalesProduct? @relation(fields: [productId], references: [id])
  quote       SalesQuote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([productId])
}

model SalesOrder {
  id                String               @id @default(cuid())
  tenantId          String
  accountId         String?
  opportunityId     String?
  quoteId           String?
  orderNumber       String               @unique
  name              String
  description       String?
  status            OrderStatus          @default(DRAFT)
  orderDate         DateTime
  requestedShipDate DateTime?
  subtotal          Decimal              @db.Decimal(15, 2)
  taxAmount         Decimal              @default(0) @db.Decimal(15, 2)
  taxRate           Decimal              @default(0) @db.Decimal(5, 2)
  shippingAmount    Decimal              @default(0) @db.Decimal(15, 2)
  discount          Decimal              @default(0) @db.Decimal(15, 2)
  totalAmount       Decimal              @db.Decimal(15, 2)
  currency          String               @default("USD")
  paymentTerms      String?
  shippingAddress   Json?
  billingAddress    Json?
  notes             String?
  createdById       String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  account           SalesAccount?        @relation(fields: [accountId], references: [id])
  createdBy         User                 @relation("OrderCreatedBy", fields: [createdById], references: [id])
  opportunity       SalesOpportunity?    @relation(fields: [opportunityId], references: [id])
  quote             SalesQuote?          @relation(fields: [quoteId], references: [id])
  tenant            Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lineItems         SalesOrderLineItem[]

  @@index([tenantId])
  @@index([accountId])
  @@index([opportunityId])
  @@index([quoteId])
  @@index([orderNumber])
  @@index([status])
  @@index([orderDate])
}

model SalesOrderLineItem {
  id          String        @id @default(cuid())
  orderId     String
  productId   String?
  name        String
  description String?
  quantity    Decimal       @db.Decimal(10, 2)
  unitPrice   Decimal       @db.Decimal(15, 2)
  discount    Decimal       @default(0) @db.Decimal(5, 2)
  totalPrice  Decimal       @db.Decimal(15, 2)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  order       SalesOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     SalesProduct? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model SalesCase {
  id           String        @id @default(cuid())
  tenantId     String
  accountId    String?
  contactId    String?
  caseNumber   String        @unique
  subject      String
  description  String?
  type         CaseType?
  priority     Priority      @default(MEDIUM)
  status       CaseStatus    @default(NEW)
  origin       CaseOrigin?
  reason       String?
  resolution   String?
  closedDate   DateTime?
  assignedToId String?
  createdById  String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  account      SalesAccount? @relation(fields: [accountId], references: [id])
  assignedTo   User?         @relation("CaseAssignedTo", fields: [assignedToId], references: [id])
  contact      SalesContact? @relation(fields: [contactId], references: [id])
  createdBy    User          @relation("CaseCreatedBy", fields: [createdById], references: [id])
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([accountId])
  @@index([contactId])
  @@index([assignedToId])
  @@index([status])
  @@index([caseNumber])
}

model SalesForecast {
  id               String             @id @default(cuid())
  tenantId         String
  userId           String?
  accountId        String
  period           String
  forecastType     ForecastPeriodType @default(MONTHLY)
  quota            Decimal            @db.Decimal(15, 2)
  forecastedAmount Decimal            @db.Decimal(15, 2)
  actualAmount     Decimal            @default(0) @db.Decimal(15, 2)
  pipelineAmount   Decimal            @default(0) @db.Decimal(15, 2)
  closedWonAmount  Decimal            @default(0) @db.Decimal(15, 2)
  closedLostAmount Decimal            @default(0) @db.Decimal(15, 2)
  attainment       Decimal            @default(0) @db.Decimal(5, 2)
  unitPrice        Decimal?           @db.Decimal(15, 2)
  volume           Decimal?           @db.Decimal(15, 2)
  revenue          Decimal            @default(0) @db.Decimal(15, 2)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  account          SalesAccount       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             User?              @relation("SalesForecastUser", fields: [userId], references: [id])

  @@unique([tenantId, accountId, period])
  @@index([tenantId])
  @@index([userId])
  @@index([accountId])
  @@index([period])
}

model SalesAutomationRule {
  id                String                @id @default(cuid())
  tenantId          String
  name              String
  description       String?
  triggerType       AutomationTriggerType
  triggerConditions Json
  actionType        AutomationActionType
  actionConfig      Json
  isActive          Boolean               @default(true)
  priority          Int                   @default(0)
  createdById       String
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  createdBy         User                  @relation("AutomationRuleCreatedBy", fields: [createdById], references: [id])
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isActive])
  @@index([triggerType])
}

model ReportingDataSource {
  id               String                     @id @default(cuid())
  tenantId         String
  name             String
  description      String?
  type             DataSourceType
  provider         String?
  connectionConfig Json
  status           DataSourceStatus           @default(ACTIVE)
  lastTestedAt     DateTime?
  lastError        String?
  createdById      String
  updatedById      String?
  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt
  createdBy        User                       @relation("DataSourceCreator", fields: [createdById], references: [id])
  tenant           Tenant                     @relation("ReportingDataSources", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy        User?                      @relation("DataSourceUpdater", fields: [updatedById], references: [id])
  tables           ReportingDataSourceTable[]
  datasets         ReportingDataset[]

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([createdById])
}

model ReportingDataSourceTable {
  id           String                      @id @default(cuid())
  dataSourceId String
  schemaName   String?
  tableName    String
  tableType    TableType                   @default(TABLE)
  description  String?
  rowCount     BigInt?
  columnCount  Int?
  lastSyncedAt DateTime?
  schema       Json?
  createdAt    DateTime                    @default(now())
  updatedAt    DateTime                    @updatedAt
  columns      ReportingDataSourceColumn[]
  dataSource   ReportingDataSource         @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  @@unique([dataSourceId, schemaName, tableName])
  @@index([dataSourceId])
}

model ReportingDataSourceColumn {
  id           String                   @id @default(cuid())
  tableId      String
  columnName   String
  dataType     String
  isNullable   Boolean                  @default(true)
  isPrimaryKey Boolean                  @default(false)
  defaultValue String?
  description  String?
  sampleValues Json?
  createdAt    DateTime                 @default(now())
  table        ReportingDataSourceTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, columnName])
  @@index([tableId])
}

model ReportingDataset {
  id                    String                       @id @default(cuid())
  tenantId              String
  name                  String
  description           String?
  type                  DatasetType
  dataSourceId          String?
  fileId                String?
  query                 String?
  transformationConfig  Json?
  schema                Json?
  rowCount              BigInt?
  lastRefreshedAt       DateTime?
  refreshSchedule       String?
  status                DatasetStatus                @default(ACTIVE)
  isPublic              Boolean                      @default(false)
  createdById           String
  updatedById           String?
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  dashboards            ReportingDashboardDataset[]
  createdBy             User                         @relation("DatasetCreator", fields: [createdById], references: [id])
  dataSource            ReportingDataSource?         @relation(fields: [dataSourceId], references: [id])
  tenant                Tenant                       @relation("ReportingDatasets", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy             User?                        @relation("DatasetUpdater", fields: [updatedById], references: [id])
  permissions           ReportingDatasetPermission[]
  insights              ReportingInsight[]
  inputTransformations  ReportingTransformation[]    @relation("InputTransformations")
  outputTransformations ReportingTransformation[]    @relation("OutputTransformations")
  visualizations        ReportingVisualization[]

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([createdById])
}

model ReportingInsight {
  id             String                       @id @default(cuid())
  tenantId       String
  datasetId      String
  insightType    InsightType
  title          String
  description    String
  severity       InsightSeverity
  confidence     Float
  actionable     Boolean                      @default(false)
  recommendation String?
  data           Json?
  metadata       Json?
  columnName     String?
  columnNames    String[]                     @default([])
  generatedById  String
  createdAt      DateTime                     @default(now())
  updatedAt      DateTime                     @updatedAt
  dataset        ReportingDataset             @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  generatedBy    User                         @relation("InsightGenerator", fields: [generatedById], references: [id])
  tenant         Tenant                       @relation("ReportingInsights", fields: [tenantId], references: [id], onDelete: Cascade)
  userActions    ReportingUserInsightAction[]

  @@index([tenantId])
  @@index([datasetId])
  @@index([insightType])
  @@index([severity])
  @@index([generatedById])
  @@index([createdAt])
}

model ReportingUserInsightAction {
  id         String            @id @default(cuid())
  tenantId   String
  insightId  String
  userId     String
  actionType InsightActionType
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  insight    ReportingInsight  @relation(fields: [insightId], references: [id], onDelete: Cascade)
  tenant     Tenant            @relation("UserInsightActions", fields: [tenantId], references: [id], onDelete: Cascade)
  user       User              @relation("UserInsightActions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([insightId, userId, actionType])
  @@index([tenantId])
  @@index([insightId])
  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
}

model ReportingVisualization {
  id               String                             @id @default(cuid())
  tenantId         String
  name             String
  description      String?
  type             VisualizationType
  datasetId        String
  config           Json
  query            String?
  filters          Json?
  xAxis            String?
  yAxis            String?
  series           Json?
  styling          Json?
  width            Int?
  height           Int?
  isPublic         Boolean                            @default(false)
  createdById      String
  updatedById      String?
  createdAt        DateTime                           @default(now())
  updatedAt        DateTime                           @updatedAt
  dashboardWidgets ReportingDashboardWidget[]
  createdBy        User                               @relation("VisualizationCreator", fields: [createdById], references: [id])
  dataset          ReportingDataset                   @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  tenant           Tenant                             @relation("ReportingVisualizations", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy        User?                              @relation("VisualizationUpdater", fields: [updatedById], references: [id])
  permissions      ReportingVisualizationPermission[]

  @@index([tenantId])
  @@index([type])
  @@index([datasetId])
  @@index([createdById])
}

model ReportingDashboardWidget {
  id              String                  @id @default(cuid())
  dashboardId     String
  visualizationId String?
  widgetType      WidgetType
  title           String?
  config          Json
  position        Json
  order           Int                     @default(0)
  filters         Json?
  refreshInterval Int?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  dashboard       ReportingDashboard      @relation("DashboardWidgets", fields: [dashboardId], references: [id], onDelete: Cascade)
  visualization   ReportingVisualization? @relation(fields: [visualizationId], references: [id])

  @@index([dashboardId])
  @@index([visualizationId])
}

model ReportingDashboardDataset {
  id          String             @id @default(cuid())
  dashboardId String
  datasetId   String
  alias       String?
  filters     Json?
  createdAt   DateTime           @default(now())
  dashboard   ReportingDashboard @relation("DashboardDatasets", fields: [dashboardId], references: [id], onDelete: Cascade)
  dataset     ReportingDataset   @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([dashboardId, datasetId])
  @@index([dashboardId])
  @@index([datasetId])
}

model ReportingReport {
  id              String                      @id @default(cuid())
  tenantId        String
  name            String
  description     String?
  type            ReportType
  templateId      String?
  dashboardId     String?
  config          Json
  format          ReportFormat                @default(PDF)
  schedule        String?
  recipients      Json?
  lastGeneratedAt DateTime?
  lastGeneratedBy String?
  fileUrl         String?
  status          ReportStatus                @default(ACTIVE)
  createdById     String
  updatedById     String?
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  createdBy       User                        @relation("ReportCreator", fields: [createdById], references: [id])
  dashboard       ReportingDashboard?         @relation("DashboardReports", fields: [dashboardId], references: [id])
  template        ReportingReportTemplate?    @relation(fields: [templateId], references: [id])
  tenant          Tenant                      @relation("ReportingReports", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy       User?                       @relation("ReportUpdater", fields: [updatedById], references: [id])
  executions      ReportingReportExecution[]
  permissions     ReportingReportPermission[]

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([createdById])
}

model ReportingReportExecution {
  id           String          @id @default(cuid())
  reportId     String
  status       ExecutionStatus @default(PENDING)
  fileUrl      String?
  errorMessage String?
  startedAt    DateTime        @default(now())
  completedAt  DateTime?
  triggeredBy  String?
  report       ReportingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([status])
  @@index([startedAt])
}

model ReportingReportTemplate {
  id           String            @id @default(cuid())
  tenantId     String
  name         String
  description  String?
  category     String?
  type         TemplateType
  config       Json
  previewImage String?
  isPublic     Boolean           @default(false)
  isSystem     Boolean           @default(false)
  usageCount   Int               @default(0)
  rating       Float?
  createdById  String
  updatedById  String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  reports      ReportingReport[]
  createdBy    User              @relation("TemplateCreator", fields: [createdById], references: [id])
  tenant       Tenant            @relation("ReportingTemplates", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy    User?             @relation("TemplateUpdater", fields: [updatedById], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([category])
  @@index([isPublic])
}

model ReportingTransformation {
  id              String               @id @default(cuid())
  tenantId        String
  name            String
  description     String?
  inputDatasetId  String
  outputDatasetId String?
  config          Json
  code            String?
  status          TransformationStatus @default(DRAFT)
  lastRunAt       DateTime?
  lastRunBy       String?
  errorMessage    String?
  createdById     String
  updatedById     String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  createdBy       User                 @relation("TransformationCreator", fields: [createdById], references: [id])
  inputDataset    ReportingDataset     @relation("InputTransformations", fields: [inputDatasetId], references: [id], onDelete: Cascade)
  outputDataset   ReportingDataset?    @relation("OutputTransformations", fields: [outputDatasetId], references: [id])
  tenant          Tenant               @relation("ReportingTransformations", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy       User?                @relation("TransformationUpdater", fields: [updatedById], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([inputDatasetId])
  @@index([createdById])
}

model ReportingDatasetPermission {
  id               String           @id @default(cuid())
  datasetId        String
  userId           String?
  orgUnitId        String?
  role             String?
  permission       PermissionLevel
  rowLevelRules    Json?
  columnLevelRules Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  dataset          ReportingDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  orgUnit          OrgUnit?         @relation("DatasetOrgUnitPermissions", fields: [orgUnitId], references: [id], onDelete: Cascade)
  user             User?            @relation("DatasetPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([datasetId])
  @@index([userId])
  @@index([orgUnitId])
}

model ReportingVisualizationPermission {
  id              String                 @id @default(cuid())
  visualizationId String
  userId          String?
  orgUnitId       String?
  role            String?
  permission      PermissionLevel
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  orgUnit         OrgUnit?               @relation("VisualizationOrgUnitPermissions", fields: [orgUnitId], references: [id], onDelete: Cascade)
  user            User?                  @relation("VisualizationPermissions", fields: [userId], references: [id], onDelete: Cascade)
  visualization   ReportingVisualization @relation(fields: [visualizationId], references: [id], onDelete: Cascade)

  @@index([visualizationId])
  @@index([userId])
  @@index([orgUnitId])
}

model ReportingDashboardPermission {
  id          String             @id @default(cuid())
  dashboardId String
  userId      String?
  orgUnitId   String?
  role        String?
  permission  PermissionLevel
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  dashboard   ReportingDashboard @relation("DashboardPermissions", fields: [dashboardId], references: [id], onDelete: Cascade)
  orgUnit     OrgUnit?           @relation("DashboardOrgUnitPermissions", fields: [orgUnitId], references: [id], onDelete: Cascade)
  user        User?              @relation("DashboardPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@index([userId])
  @@index([orgUnitId])
}

model ReportingReportPermission {
  id         String          @id @default(cuid())
  reportId   String
  userId     String?
  orgUnitId  String?
  role       String?
  permission PermissionLevel
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  orgUnit    OrgUnit?        @relation("ReportOrgUnitPermissions", fields: [orgUnitId], references: [id], onDelete: Cascade)
  report     ReportingReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user       User?           @relation("ReportPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([userId])
  @@index([orgUnitId])
}

model OrganizationPermission {
  id          String    @id @default(cuid())
  tenantId    String
  orgUnitId   String?
  userId      String?
  role        UserRole?
  resource    String
  actions     String[]
  conditions  Json?
  inheritance Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String
  createdBy   User      @relation("PermissionCreator", fields: [createdById], references: [id])
  orgUnit     OrgUnit?  @relation("OrgUnitPermissions", fields: [orgUnitId], references: [id], onDelete: Cascade)
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?     @relation("UserOrgPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, orgUnitId, userId, role, resource], name: "org_permission_unique")
  @@index([tenantId])
  @@index([orgUnitId])
  @@index([userId])
  @@index([role])
  @@index([resource])
}

model FunctionPermission {
  id          String    @id @default(cuid())
  tenantId    String
  orgUnitId   String?
  userId      String?
  role        UserRole?
  function    String
  allowed     Boolean   @default(true)
  conditions  Json?
  inheritance Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String
  createdBy   User      @relation("FunctionPermissionCreator", fields: [createdById], references: [id])
  orgUnit     OrgUnit?  @relation("OrgUnitFunctionPermissions", fields: [orgUnitId], references: [id], onDelete: Cascade)
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?     @relation("UserFunctionPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, orgUnitId, userId, role, function], name: "function_permission_unique")
  @@index([tenantId])
  @@index([orgUnitId])
  @@index([userId])
  @@index([role])
  @@index([function])
}

model PermissionInheritance {
  id              String   @id @default(cuid())
  parentOrgUnitId String
  childOrgUnitId  String
  permissionType  String
  permissionId    String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  childOrgUnit    OrgUnit  @relation("PermissionInheritanceChild", fields: [childOrgUnitId], references: [id], onDelete: Cascade)
  parentOrgUnit   OrgUnit  @relation("PermissionInheritanceParent", fields: [parentOrgUnitId], references: [id], onDelete: Cascade)

  @@unique([parentOrgUnitId, childOrgUnitId, permissionType, permissionId], name: "permission_inheritance_unique")
  @@index([parentOrgUnitId])
  @@index([childOrgUnitId])
  @@index([permissionType, permissionId])
}

model AccessAuditLog {
  id              String       @id @default(cuid())
  tenantId        String
  userId          String
  resource        String
  resourceId      String?
  action          String
  result          AccessResult @default(GRANTED)
  reason          String?
  ipAddress       String?
  userAgent       String?
  metadata        Json?
  permissionCheck Json?
  createdAt       DateTime     @default(now())
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User         @relation("AccessAuditLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([resource, resourceId])
  @@index([action])
  @@index([result])
  @@index([createdAt])
}

model RowLevelSecurityRule {
  id             String          @id @default(cuid())
  tenantId       String
  resource       String
  name           String
  description    String?
  userId         String?
  orgUnitId      String?
  role           UserRole?
  ruleExpression Json
  priority       Int             @default(0)
  isActive       Boolean         @default(true)
  appliesTo      RuleAppliesTo[]
  inheritance    Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  createdById    String
  createdBy      User            @relation("RLSRuleCreator", fields: [createdById], references: [id])
  orgUnit        OrgUnit?        @relation("RLSOrgUnitRules", fields: [orgUnitId], references: [id], onDelete: Cascade)
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user           User?           @relation("RLSUserRules", fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([resource])
  @@index([userId])
  @@index([orgUnitId])
  @@index([role])
  @@index([isActive, priority])
}

model ColumnLevelSecurityRule {
  id            String               @id @default(cuid())
  tenantId      String
  resource      String
  column        String
  userId        String?
  orgUnitId     String?
  role          UserRole?
  action        ColumnSecurityAction
  maskingType   MaskingType?
  maskingConfig Json?
  isActive      Boolean              @default(true)
  inheritance   Boolean              @default(true)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  createdById   String
  createdBy     User                 @relation("CLSRuleCreator", fields: [createdById], references: [id])
  orgUnit       OrgUnit?             @relation("CLSOrgUnitRules", fields: [orgUnitId], references: [id], onDelete: Cascade)
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User?                @relation("CLSUserRules", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, resource, column, userId, orgUnitId, role], name: "cls_rule_unique")
  @@index([tenantId])
  @@index([resource])
  @@index([column])
  @@index([userId])
  @@index([orgUnitId])
  @@index([role])
  @@index([isActive])
}

model RLSCacheEntry {
  id               String   @id @default(cuid())
  tenantId         String
  userId           String
  resource         String
  ruleId           String
  cacheKey         String   @unique
  evaluationResult Json
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user             User     @relation("RLSCacheEntries", fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, resource])
  @@index([cacheKey])
  @@index([expiresAt])
}

model Comment {
  id           String       @id @default(cuid())
  tenantId     String
  resourceType String
  resourceId   String
  userId       String
  content      String
  mentions     String[]
  parentId     String?
  isEdited     Boolean      @default(false)
  isDeleted    Boolean      @default(false)
  isPinned     Boolean      @default(false)
  reactions    Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  annotations  Annotation[]
  parent       Comment?     @relation("CommentReplies", fields: [parentId], references: [id])
  replies      Comment[]    @relation("CommentReplies")
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User         @relation("CommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  mentions_    Mention[]

  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

model Annotation {
  id           String         @id @default(cuid())
  tenantId     String
  resourceType String
  resourceId   String
  commentId    String?
  userId       String
  type         AnnotationType
  position     Json
  content      String
  style        Json?
  isResolved   Boolean        @default(false)
  resolvedById String?
  resolvedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  comment      Comment?       @relation(fields: [commentId], references: [id])
  resolvedBy   User?          @relation("AnnotationResolver", fields: [resolvedById], references: [id])
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User           @relation("AnnotationAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([userId])
  @@index([commentId])
  @@index([isResolved])
}

model ResourceShare {
  id           String          @id @default(cuid())
  tenantId     String
  resourceType String
  resourceId   String
  sharedById   String
  sharedWithId String?
  orgUnitId    String?
  role         UserRole?
  permission   SharePermission @default(VIEW)
  accessType   ShareAccessType @default(SPECIFIC_USER)
  shareToken   String?         @unique
  expiresAt    DateTime?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  orgUnit      OrgUnit?        @relation(fields: [orgUnitId], references: [id], onDelete: Cascade)
  sharedBy     User            @relation("ResourceSharer", fields: [sharedById], references: [id], onDelete: Cascade)
  sharedWith   User?           @relation("ResourceSharedWith", fields: [sharedWithId], references: [id], onDelete: Cascade)
  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, resourceType, resourceId, sharedWithId, orgUnitId, role], name: "resource_share_unique")
  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([sharedById])
  @@index([sharedWithId])
  @@index([orgUnitId])
  @@index([shareToken])
  @@index([isActive])
}

model ActivityFeed {
  id           String         @id @default(cuid())
  tenantId     String
  userId       String?
  resourceType String
  resourceId   String?
  action       ActivityAction
  description  String
  metadata     Json?
  mentions     String[]
  isRead       Boolean        @default(false)
  createdAt    DateTime       @default(now())
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User?          @relation("ActivityActor", fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([isRead])
  @@index([createdAt])
}

model Mention {
  id              String    @id @default(cuid())
  tenantId        String
  resourceType    String
  resourceId      String
  commentId       String?
  mentionedById   String
  mentionedUserId String
  context         String?
  isRead          Boolean   @default(false)
  readAt          DateTime?
  createdAt       DateTime  @default(now())
  comment         Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentionedBy     User      @relation("MentionCreator", fields: [mentionedById], references: [id], onDelete: Cascade)
  mentionedUser   User      @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([mentionedUserId, isRead])
  @@index([resourceType, resourceId])
  @@index([commentId])
  @@index([createdAt])
}

model DataLineage {
  id               String                  @id @default(cuid())
  tenantId         String
  sourceType       String
  sourceId         String
  targetType       String
  targetId         String
  relationshipType LineageRelationshipType
  metadata         Json?
  createdAt        DateTime                @default(now())
  tenant           Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@index([relationshipType])
}

model DataQualityMetric {
  id           String            @id @default(cuid())
  tenantId     String
  resourceType String
  resourceId   String
  metricType   QualityMetricType
  metricValue  Float
  threshold    Float?
  status       QualityStatus
  details      Json?
  evaluatedAt  DateTime          @default(now())
  createdAt    DateTime          @default(now())
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([metricType])
  @@index([status])
  @@index([evaluatedAt])
}

model DataUsage {
  id           String      @id @default(cuid())
  tenantId     String
  resourceType String
  resourceId   String
  userId       String?
  action       UsageAction
  metadata     Json?
  duration     Int?
  createdAt    DateTime    @default(now())
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User?       @relation("DataUsageUser", fields: [userId], references: [id])

  @@index([tenantId, createdAt])
  @@index([resourceType, resourceId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model DataRetentionPolicy {
  id             String          @id @default(cuid())
  tenantId       String
  resourceType   String
  name           String
  description    String?
  retentionDays  Int
  action         RetentionAction
  conditions     Json?
  isActive       Boolean         @default(true)
  lastExecutedAt DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  createdById    String
  createdBy      User            @relation("RetentionPolicyCreator", fields: [createdById], references: [id])
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([resourceType])
  @@index([isActive])
}

model ComplianceReport {
  id            String                 @id @default(cuid())
  tenantId      String
  reportType    ComplianceReportType
  name          String
  description   String?
  periodStart   DateTime
  periodEnd     DateTime
  generatedById String
  data          Json
  status        ComplianceReportStatus @default(DRAFT)
  generatedAt   DateTime               @default(now())
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  generatedBy   User                   @relation("ComplianceReportGenerator", fields: [generatedById], references: [id])
  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([reportType])
  @@index([periodStart, periodEnd])
  @@index([status])
  @@index([generatedAt])
}

model DataCatalogEntry {
  id                String              @id @default(cuid())
  tenantId          String
  resourceType      String
  resourceId        String
  name              String
  description       String?
  tags              String[]
  category          String?
  ownerId           String?
  classification    DataClassification?
  sensitivity       DataSensitivity?
  businessGlossary  Json?
  technicalMetadata Json?
  customFields      Json?
  isPublished       Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  owner             User?               @relation("DataCatalogOwner", fields: [ownerId], references: [id])
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, resourceType, resourceId], name: "catalog_entry_unique")
  @@index([tenantId])
  @@index([resourceType, resourceId])
  @@index([category])
  @@index([classification])
  @@index([isPublished])
}

model Integration {
  id               String                       @id @default(cuid())
  tenantId         String
  type             IntegrationType
  name             String
  description      String?
  status           IntegrationStatus            @default(INACTIVE)
  configuration    Json?
  isActive         Boolean                      @default(false)
  lastSyncAt       DateTime?
  lastError        String?
  errorCount       Int                          @default(0)
  createdAt        DateTime                     @default(now())
  updatedAt        DateTime                     @updatedAt
  createdById      String
  createdBy        User                         @relation("IntegrationCreator", fields: [createdById], references: [id])
  tenant           Tenant                       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fieldMappings    IntegrationFieldMapping[]
  syncJobs         IntegrationSyncJob[]
  syncLogs         IntegrationSyncLog[]
  templateInstalls IntegrationTemplateInstall[]
  webhooks         IntegrationWebhook[]
  oauthTokens      OAuthToken[]

  @@unique([tenantId, type], name: "integration_unique")
  @@index([tenantId])
  @@index([type])
  @@index([status])
}

model OAuthToken {
  id            String      @id @default(cuid())
  integrationId String
  tenantId      String
  accessToken   String
  refreshToken  String?
  tokenType     String      @default("Bearer")
  expiresAt     DateTime?
  scope         String?
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([tenantId])
  @@index([expiresAt])
}

model IntegrationSyncJob {
  id               String               @id @default(cuid())
  integrationId    String
  tenantId         String
  syncType         SyncType
  status           SyncJobStatus        @default(PENDING)
  configuration    Json
  startedAt        DateTime?
  completedAt      DateTime?
  recordsProcessed Int                  @default(0)
  recordsCreated   Int                  @default(0)
  recordsUpdated   Int                  @default(0)
  recordsFailed    Int                  @default(0)
  errorMessage     String?
  metadata         Json?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  integration      Integration          @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant           Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  syncLogs         IntegrationSyncLog[]

  @@index([integrationId])
  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

model IntegrationSyncLog {
  id            String              @id @default(cuid())
  integrationId String
  syncJobId     String?
  tenantId      String
  level         LogLevel
  message       String
  details       Json?
  createdAt     DateTime            @default(now())
  integration   Integration         @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  syncJob       IntegrationSyncJob? @relation(fields: [syncJobId], references: [id])
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([syncJobId])
  @@index([tenantId])
  @@index([level])
  @@index([createdAt])
}

model IntegrationWebhook {
  id              String      @id @default(cuid())
  integrationId   String
  tenantId        String
  eventType       String
  webhookUrl      String
  webhookId       String?
  secret          String?
  isActive        Boolean     @default(true)
  lastTriggeredAt DateTime?
  triggerCount    Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant          Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([tenantId])
  @@index([eventType])
  @@index([isActive])
}

model IntegrationFieldMapping {
  id             String      @id @default(cuid())
  integrationId  String
  tenantId       String
  sourceField    String
  targetField    String
  mappingType    MappingType
  transformation Json?
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  integration    Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([tenantId])
  @@index([sourceField])
}

model IntegrationTemplate {
  id              String                       @id @default(cuid())
  integrationType IntegrationType
  name            String
  description     String
  category        String
  tags            String[]
  thumbnailUrl    String?
  configuration   Json
  fieldMappings   Json?
  syncConfig      Json?
  documentation   String?
  usageCount      Int                          @default(0)
  rating          Float?
  isFeatured      Boolean                      @default(false)
  isActive        Boolean                      @default(true)
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt
  createdById     String?
  createdBy       User?                        @relation("TemplateCreator", fields: [createdById], references: [id])
  installations   IntegrationTemplateInstall[]
  reviews         IntegrationTemplateReview[]

  @@index([integrationType])
  @@index([category])
  @@index([isFeatured])
  @@index([isActive])
}

model IntegrationTemplateReview {
  id         String              @id @default(cuid())
  templateId String
  userId     String
  tenantId   String
  rating     Int
  comment    String?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  template   IntegrationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User                @relation("TemplateReviewer", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId, tenantId], name: "template_review_unique")
  @@index([templateId])
  @@index([userId])
}

model IntegrationTemplateInstall {
  id            String              @id @default(cuid())
  templateId    String
  integrationId String
  tenantId      String
  installedAt   DateTime            @default(now())
  integration   Integration         @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  template      IntegrationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([integrationId])
  @@index([tenantId])
}

model IntegrationCategory {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?
  icon         String?
  color        String?
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([slug])
  @@index([displayOrder])
}

model Grid {
  id            String           @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  rowCount      Int              @default(1000)
  columnCount   Int              @default(26)
  frozenRows    Int              @default(0)
  frozenColumns Int              @default(0)
  isPublic      Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  createdById   String
  updatedById   String?
  createdBy     User             @relation("GridCreator", fields: [createdById], references: [id])
  tenant        Tenant           @relation("Grids", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy     User?            @relation("GridUpdater", fields: [updatedById], references: [id])
  cells         GridCell[]
  columns       GridColumn[]
  formats       GridFormat[]
  formulas      GridFormula[]
  validations   GridValidation[]

  @@index([tenantId])
  @@index([createdById])
  @@index([isPublic])
}

model GridColumn {
  id        String         @id @default(cuid())
  gridId    String
  index     Int
  name      String?
  width     Int            @default(100)
  type      GridColumnType @default(TEXT)
  format    String?
  isVisible Boolean        @default(true)
  isLocked  Boolean        @default(false)
  sortOrder Int?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  grid      Grid           @relation(fields: [gridId], references: [id], onDelete: Cascade)

  @@unique([gridId, index])
  @@index([gridId])
}

model GridCell {
  id            String           @id @default(cuid())
  gridId        String
  rowIndex      Int
  columnIndex   Int
  value         String?
  displayValue  String?
  formula       String?
  dataType      GridCellDataType @default(TEXT)
  isLocked      Boolean          @default(false)
  comment       String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  updatedById   String?
  grid          Grid             @relation(fields: [gridId], references: [id], onDelete: Cascade)
  updatedBy     User?            @relation("GridCellUpdater", fields: [updatedById], references: [id])
  format        GridFormat?      @relation("CellFormat")
  formulaRecord GridFormula?     @relation("CellFormula")

  @@unique([gridId, rowIndex, columnIndex])
  @@index([gridId])
  @@index([gridId, rowIndex])
  @@index([gridId, columnIndex])
}

model GridFormula {
  id             String    @id @default(cuid())
  gridId         String
  cellId         String    @unique
  formula        String
  dependencies   String[]
  result         String?
  error          String?
  isVolatile     Boolean   @default(false)
  lastCalculated DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  cell           GridCell  @relation("CellFormula", fields: [cellId], references: [id], onDelete: Cascade)
  grid           Grid      @relation(fields: [gridId], references: [id], onDelete: Cascade)

  @@index([gridId])
  @@index([cellId])
}

model GridValidation {
  id           String         @id @default(cuid())
  gridId       String
  columnIndex  Int?
  rowIndex     Int?
  type         ValidationType
  rule         Json
  errorMessage String?
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  grid         Grid           @relation(fields: [gridId], references: [id], onDelete: Cascade)

  @@index([gridId])
  @@index([gridId, columnIndex])
}

model GridFormat {
  id          String     @id @default(cuid())
  gridId      String
  cellId      String?    @unique
  startRow    Int?
  endRow      Int?
  startColumn Int?
  endColumn   Int?
  type        FormatType
  condition   Json?
  style       Json
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  cell        GridCell?  @relation("CellFormat", fields: [cellId], references: [id], onDelete: Cascade)
  grid        Grid       @relation(fields: [gridId], references: [id], onDelete: Cascade)

  @@index([gridId])
  @@index([cellId])
}

model ReportingQueryCache {
  id             String    @id @default(cuid())
  tenantId       String
  queryHash      String    @unique
  query          String
  resultHash     String?
  resultUrl      String?
  expiresAt      DateTime
  hitCount       Int       @default(0)
  lastAccessedAt DateTime?
  createdAt      DateTime  @default(now())
  tenant         Tenant    @relation("ReportingQueryCache", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([queryHash])
  @@index([expiresAt])
}

model ReportingQueryLog {
  id           String    @id @default(cuid())
  tenantId     String
  userId       String?
  query        String
  queryType    QueryType
  duration     Int?
  rowCount     Int?
  errorMessage String?
  cached       Boolean   @default(false)
  createdAt    DateTime  @default(now())
  tenant       Tenant    @relation("ReportingQueryLogs", fields: [tenantId], references: [id], onDelete: Cascade)
  user         User?     @relation("QueryLogs", fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([queryType])
  @@index([createdAt])
}

model ReportingActivity {
  id         String         @id @default(cuid())
  tenantId   String
  userId     String?
  entityType EntityType
  entityId   String
  action     ActivityAction
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime       @default(now())
  tenant     Tenant         @relation("ReportingActivities", fields: [tenantId], references: [id], onDelete: Cascade)
  user       User?          @relation("ReportingActivities", fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum UserRole {
  TENANT_SUPER_ADMIN
  ORG_ADMIN
  PMO_LEAD
  PROJECT_MANAGER
  TEAM_MEMBER
  RESOURCE_MANAGER
  FINANCE_CONTROLLER
  EXECUTIVE
  CLIENT_STAKEHOLDER
  COMPLIANCE_AUDITOR
  INTEGRATION_ADMIN
  PLATFORM_OWNER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  SUSPENDED
}

enum WorkspaceType {
  ORGANIZATION
  GROUP
}

enum GroupRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

enum ProgramStatus {
  PLANNED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectStatus {
  PLANNED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum RAGStatus {
  RED
  AMBER
  GREEN
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  DONE
  CANCELLED
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum CallType {
  ONE_ON_ONE
  GROUP
  SCHEDULED
}

enum CallStatus {
  INITIATED
  RINGING
  ACTIVE
  ENDED
  CANCELLED
}

enum ParticipantRole {
  HOST
  PARTICIPANT
  MODERATOR
}

enum RiskProbability {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum RiskImpact {
  NEGLIGIBLE
  MINOR
  MODERATE
  MAJOR
  CRITICAL
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  IDENTIFIED
  ACTIVE
  MITIGATED
  CLOSED
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssueSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ChangeRequestStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum GoalLevel {
  COMPANY
  DEPARTMENT
  TEAM
  INDIVIDUAL
}

enum GoalStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
}

enum ApprovalType {
  PROJECT_CHARTER
  PROJECT_CLOSURE
  BUDGET
  CHANGE_REQUEST
  TIMESHEET
  OTHER
}

enum SSOProvider {
  SAML
  OIDC
  AZURE_AD
  GOOGLE_WORKSPACE
}

enum WorkflowType {
  SOFTWARE_DEVELOPMENT
  PRODUCT_MANAGEMENT
  MARKETING
  HUMAN_RESOURCES
  LEGAL
  CUSTOMER_SERVICE
  OPERATIONS
  IT_SUPPORT
  FINANCE
  SALES
  GENERAL
}

enum MethodologyType {
  AGILE
  SCRUM
  KANBAN
  WATERFALL
  LEAN
  HYBRID
  NONE
}

enum NotificationType {
  MENTION
  ASSIGNMENT
  APPROVAL
  DEADLINE
  STATUS_CHANGE
  COMMENT
  MESSAGE
  TASK_COMPLETED
  PROJECT_UPDATE
  OVERDUE_TASK
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PERMISSION_CHANGE
  SSO_CONFIG_CHANGE
  RETENTION_CONFIG_CHANGE
  DATA_CLEANUP
  EXPORT
  IMPORT
}

enum AuditEntity {
  USER
  PROJECT
  TASK
  PROGRAM
  INITIATIVE
  GOAL
  OKR
  RISK
  ISSUE
  APPROVAL
  REPORT
  NOTIFICATION
  ORG_UNIT
  TENANT
  SSO_SETTINGS
  RETENTION_SETTINGS
  TUTORIAL
  COLLABORATION
}

enum TutorialType {
  VIDEO
  TEXT
  INTERACTIVE
}

enum TutorialLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum TutorialSection {
  PROJECT_MANAGEMENT
  TOOLS_WORKINGS
}

enum CollaborationType {
  PROJECT
  TASK
  GENERAL
  BRAINSTORM
  REVIEW
  PLANNING
}

enum CollaborationStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum CollaborationRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum SuggestionType {
  CHANGE
  ADDITION
  REMOVAL
  GENERAL
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
  IMPLEMENTED
}

enum ReleaseStatus {
  PLANNED
  IN_PROGRESS
  RELEASED
  CANCELLED
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum DependencyType {
  BLOCKS
  BLOCKED_BY
  DEPENDS_ON
  RELATED_TO
}

enum DependencyStatus {
  ACTIVE
  RESOLVED
  AT_RISK
  BLOCKED
}

enum TeamStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum BudgetStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  LOCKED
  ARCHIVED
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
  CANCELLED
}

enum ForecastType {
  AI_POWERED
  MANUAL
  SCENARIO
  HYBRID
}

enum ScenarioType {
  BEST_CASE
  BASE_CASE
  WORST_CASE
}

enum ForecastModel {
  LINEAR
  EXPONENTIAL
  SEASONAL
  MOVING_AVERAGE
  CUSTOM
}

enum CostType {
  DIRECT
  INDIRECT
  FIXED
  VARIABLE
}

enum CostSource {
  MANUAL
  TIMESHEET
  INVOICE
  FILE_UPLOAD
  AI_EXTRACTED
}

enum RateCardStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum PricingType {
  FIXED_PRICE
  TIME_MATERIALS
  COST_PLUS
  HYBRID
}

enum PricingStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  ARCHIVED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  IN_REVIEW
  APPROVED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
  VOID
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  REFUNDED
}

enum FileUploadType {
  BUDGET
  COST
  INVOICE
  TIMESHEET
  RATE_CARD
  FORECAST
}

enum FileStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_PROCESSED
}

enum AccountType {
  CUSTOMER
  PARTNER
  COMPETITOR
  RESELLER
  PROSPECT
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum AccountRating {
  HOT
  WARM
  COLD
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum LeadSource {
  WEB_FORM
  EMAIL
  PHONE
  ADVERTISING
  EVENT
  REFERRAL
  PARTNER
  SOCIAL_MEDIA
  LINKEDIN
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  UNQUALIFIED
  NURTURING
}

enum LeadRating {
  HOT
  WARM
  COLD
}

enum OpportunityStage {
  PROSPECTING
  QUALIFICATION
  NEEDS_ANALYSIS
  VALUE_PROPOSITION
  ID_DECISION_MAKERS
  PERCEPTION_ANALYSIS
  PROPOSAL_PRICE_QUOTE
  NEGOTIATION_REVIEW
  CLOSED_WON
  CLOSED_LOST
}

enum OpportunityType {
  NEW_BUSINESS
  EXISTING_BUSINESS
  UPSELL
  CROSS_SELL
  RENEWAL
}

enum OpportunityStatus {
  OPEN
  WON
  LOST
  ABANDONED
}

enum ContactRole {
  DECISION_MAKER
  INFLUENCER
  EVALUATOR
  CHAMPION
  BLOCKER
  GATEKEEPER
  END_USER
  OTHER
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  TASK
  NOTE
  EVENT
}

enum ActivityStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED
}

enum DiscountType {
  AMOUNT
  PERCENTAGE
}

enum ContractType {
  SOW
  MSA
  NDA
  OTHER
}

enum ContractStatus {
  DRAFT
  IN_REVIEW
  NEGOTIATION
  APPROVED
  EXECUTED
  TERMINATED
}

enum RiskFlagType {
  INDEMNITY
  LIABILITY_CAP
  PAYMENT_TERMS
  TERMINATION
  IP_OWNERSHIP
  DATA_SECURITY
  OTHER
}

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CommentType {
  INTERNAL
  CUSTOMER_REQUEST
  LEGAL_REVIEW
}

enum OpenItemStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum OrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  IN_FULFILLMENT
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum CaseType {
  QUESTION
  PROBLEM
  FEATURE_REQUEST
  COMPLAINT
  OTHER
}

enum CaseStatus {
  NEW
  IN_PROGRESS
  ESCALATED
  RESOLVED
  CLOSED
  CANCELLED
}

enum CaseOrigin {
  EMAIL
  PHONE
  WEB
  SOCIAL
  PARTNER
  INTERNAL
}

enum ForecastPeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum AutomationTriggerType {
  LEAD_CREATED
  LEAD_STATUS_CHANGED
  LEAD_SCORED
  OPPORTUNITY_CREATED
  OPPORTUNITY_STAGE_CHANGED
  OPPORTUNITY_AMOUNT_CHANGED
  ACTIVITY_COMPLETED
  QUOTE_SENT
  ORDER_CREATED
}

enum AutomationActionType {
  ASSIGN_LEAD
  SEND_EMAIL
  CREATE_TASK
  UPDATE_FIELD
  CREATE_ACTIVITY
  CHANGE_STAGE
  NOTIFY_USER
}

enum EmailSequenceTriggerType {
  LEAD_CREATED
  LEAD_QUALIFIED
  OPPORTUNITY_CREATED
  QUOTE_SENT
  MANUAL
}

enum EntityType {
  DATASOURCE
  DATASET
  VISUALIZATION
  DASHBOARD
  REPORT
  TEMPLATE
  TRANSFORMATION
}

enum ExecutionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ApprovalEntityType {
  QUOTE
  DISCOUNT
  CONTRACT
  ORDER
  CUSTOM
}

enum ApprovalDecision {
  PENDING
  APPROVED
  REJECTED
  DELEGATED
}

enum SalesIntegrationType {
  CRM
  COMMUNICATION
  MARKETING
  PRODUCTIVITY
  FINANCIAL
  DOCUMENT
  OTHER
}

enum SalesIntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  PENDING
}

enum SyncDirection {
  FROM_EXTERNAL
  TO_EXTERNAL
  BIDIRECTIONAL
}

enum SyncFrequency {
  MANUAL
  HOURLY
  DAILY
  WEEKLY
  REAL_TIME
}

enum SyncStatus {
  SUCCESS
  FAILED
  PARTIAL
  IN_PROGRESS
}

enum SalesFieldMappingType {
  DIRECT
  TRANSFORM
  LOOKUP
  CONCATENATE
  CALCULATED
  DEFAULT
}

enum SalesDashboardType {
  PERSONAL
  TEAM
  EXECUTIVE
  CUSTOM
}

enum DataSourceType {
  DATABASE
  API
  FILE
  CLOUD_STORAGE
  SAAS_INTEGRATION
}

enum DataSourceStatus {
  ACTIVE
  INACTIVE
  ERROR
  TESTING
}

enum TableType {
  TABLE
  VIEW
  MATERIALIZED_VIEW
}

enum DatasetType {
  QUERY
  FILE
  API
  TRANSFORMATION
  MERGED
}

enum DatasetStatus {
  ACTIVE
  INACTIVE
  ERROR
  REFRESHING
}

enum InsightActionType {
  DISMISSED
  FAVORITED
  VIEWED
}

enum InsightType {
  STATISTICAL
  TREND
  ANOMALY
  CORRELATION
  PATTERN
  SUMMARY
}

enum InsightSeverity {
  INFO
  WARNING
  CRITICAL
}

enum VisualizationType {
  BAR
  LINE
  AREA
  PIE
  DONUT
  SCATTER
  BUBBLE
  HEATMAP
  SANKEY
  TREEMAP
  SUNBURST
  FUNNEL
  GAUGE
  KPI
  TABLE
  PIVOT_TABLE
  MAP_CHOROPLETH
  MAP_POINT
  MAP_HEAT
  WATERFALL
  BOX_PLOT
  GANTT
  NETWORK
  CUSTOM
}

enum WidgetType {
  VISUALIZATION
  KPI
  TEXT
  IMAGE
  IFRAME
  FILTER_CONTROL
  CUSTOM
}

enum ReportType {
  DASHBOARD_EXPORT
  QUERY_RESULT
  CUSTOM
  SCHEDULED
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  POWERPOINT
  HTML
  JSON
}

enum ReportStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum ReportExecutionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TemplateType {
  DASHBOARD
  REPORT
  VISUALIZATION
}

enum ScheduleFrequency {
  ONCE
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum ScheduleStatus {
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
}

enum DeliveryChannel {
  EMAIL
  SLACK
  TEAMS
  WEBHOOK
  GOOGLE_DRIVE
  DROPBOX
  ONEDRIVE
  S3
}

enum DeliveryStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum ExportFormat {
  PDF
  EXCEL
  CSV
  JSON
  PNG
  HTML
}

enum TransformationStatus {
  DRAFT
  ACTIVE
  ERROR
}

enum PermissionLevel {
  NONE
  VIEW
  EDIT
  DELETE
  ADMIN
}

enum AccessResult {
  GRANTED
  DENIED
  ERROR
}

enum RuleAppliesTo {
  CREATE
  READ
  UPDATE
  DELETE
}

enum ColumnSecurityAction {
  HIDE
  MASK
  PARTIAL_MASK
  READ_ONLY
}

enum MaskingType {
  FULL
  PARTIAL
  HASH
  REDACT
  CUSTOM
}

enum AnnotationType {
  HIGHLIGHT
  NOTE
  ARROW
  RECTANGLE
  CIRCLE
  TEXT
}

enum SharePermission {
  VIEW
  COMMENT
  EDIT
  ADMIN
}

enum ShareAccessType {
  SPECIFIC_USER
  ORG_UNIT
  ROLE
  PUBLIC_LINK
  PRIVATE_LINK
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  SHARE
  EXPORT
  EXECUTE
  PERMISSION_CHANGE
  CREATED
  UPDATED
  DELETED
  SHARED
  COMMENTED
  ANNOTATED
  MENTIONED
  REACTED
  VIEWED
  EXPORTED
  APPROVED
  REJECTED
}

enum LineageRelationshipType {
  DERIVED_FROM
  USED_IN
  TRANSFORMED_FROM
  MERGED_FROM
  COPIED_FROM
  REFERENCED_BY
}

enum QualityMetricType {
  COMPLETENESS
  ACCURACY
  CONSISTENCY
  VALIDITY
  UNIQUENESS
  TIMELINESS
  INTEGRITY
  CUSTOM
}

enum QualityStatus {
  PASS
  WARNING
  FAIL
}

enum UsageAction {
  VIEWED
  QUERIED
  EXPORTED
  SHARED
  CREATED
  UPDATED
  DELETED
  DOWNLOADED
  REFRESHED
}

enum RetentionAction {
  ARCHIVE
  DELETE
  ANONYMIZE
  MOVE_TO_COLD
}

enum ComplianceReportType {
  DATA_ACCESS
  DATA_QUALITY
  RETENTION
  SECURITY_AUDIT
  PRIVACY
  CUSTOM
}

enum ComplianceReportStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ARCHIVED
}

enum DataClassification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
  CLASSIFIED
}

enum DataSensitivity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IntegrationType {
  SALESFORCE
  HUBSPOT
  QUICKBOOKS
  STRIPE
  GOOGLE_ANALYTICS
  ZENDESK
  JIRA
  MAILCHIMP
  SLACK
  MICROSOFT_TEAMS
  SHOPIFY
  CUSTOM
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  PAUSED
  SYNCING
}

enum SyncType {
  FULL_SYNC
  INCREMENTAL
  SELECTIVE
  SCHEDULED
  MANUAL
}

enum SyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum LogLevel {
  INFO
  WARNING
  ERROR
  DEBUG
}

enum MappingType {
  DIRECT
  TRANSFORM
  LOOKUP
  CONCATENATE
  CALCULATED
}

enum GridColumnType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  FORMULA
  CURRENCY
  PERCENTAGE
  EMAIL
  URL
}

enum GridCellDataType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  FORMULA
  ERROR
}

enum ValidationType {
  REQUIRED
  NUMBER_RANGE
  TEXT_LENGTH
  TEXT_PATTERN
  DATE_RANGE
  CUSTOM_LIST
  UNIQUE
}

enum FormatType {
  CONDITIONAL
  STATIC
  DATA_BAR
  COLOR_SCALE
  ICON_SET
}

enum TransformationOperator {
  READ_DATASET
  READ_CSV
  READ_JSON
  READ_API
  FILTER
  WHERE
  DISTINCT
  SELECT_COLUMNS
  RENAME_COLUMNS
  ADD_COLUMN
  REMOVE_COLUMNS
  SORT
  LIMIT
  OFFSET
  GROUP_BY
  AGGREGATE
  PIVOT
  UNPIVOT
  INNER_JOIN
  LEFT_JOIN
  RIGHT_JOIN
  FULL_JOIN
  UNION
  CALCULATE
  FORMAT_DATE
  PARSE_NUMBER
  CONCATENATE
  FILL_NULLS
  REMOVE_DUPLICATES
  VALIDATE_DATA
  CLEAN_DATA
  WRITE_DATASET
  EXPORT_CSV
  EXPORT_JSON
}

enum QueryType {
  SELECT
  INSERT
  UPDATE
  DELETE
  EXPLAIN
  CUSTOM
}

enum ReportingEntityType {
  DATASOURCE
  DATASET
  VISUALIZATION
  DASHBOARD
  REPORT
  TEMPLATE
  TRANSFORMATION
}

enum WorkOrderStatus {
  OPEN
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum InventoryCategory {
  SUPPLIES
  EQUIPMENT
  SAFETY
  TOOLS
  IT_EQUIPMENT
  OFFICE_SUPPLIES
  OTHER
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  RESERVED
  IN_TRANSIT
}

enum DistributionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EARLY_LEAVE
  ON_LEAVE
  SICK_LEAVE
}

enum ShiftStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum TrainingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  CANCELLED
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum KPITrend {
  IMPROVING
  STABLE
  DECLINING
  INCREASING
}

enum KPIStatus {
  ON_TRACK
  AT_RISK
  OFF_TRACK
  EXCEEDED
}

enum ComplianceIssueType {
  PROCESS_VIOLATION
  DOCUMENTATION
  TRAINING
  SAFETY
  REGULATORY
  OTHER
}

enum RiskCategory {
  OPERATIONAL
  COMPLIANCE
  TECHNICAL
  FINANCIAL
  REPUTATIONAL
  OTHER
}

enum RiskLikelihood {
  LOW
  MEDIUM
  HIGH
}

enum OperationsRiskImpact {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum MitigationStatus {
  NOT_STARTED
  PLANNED
  IN_PROGRESS
  MITIGATED
  ACCEPTED
}

enum IncidentType {
  SAFETY
  QUALITY
  SECURITY
  OPERATIONAL
  ENVIRONMENTAL
  OTHER
}

enum IncidentStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

enum VendorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ServiceRequestStatus {
  OPEN
  IN_PROGRESS
  PENDING_APPROVAL
  RESOLVED
  CLOSED
  CANCELLED
}

enum ServiceRequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  EMERGENCY
  INSPECTION
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED
}

model OperationsVendor {
  id                  String        @id @default(cuid())
  tenantId            String
  name                String
  category            String?
  contactPerson       String?
  email               String?
  phone               String?
  address             String?
  city                String?
  state               String?
  country             String?
  zipCode             String?
  website             String?
  taxId               String?
  status              VendorStatus  @default(ACTIVE)
  contractValue       Decimal?      @db.Decimal(15, 2)
  contractStartDate   DateTime?
  contractEndDate     DateTime?
  rating              Decimal?      @default(0) @db.Decimal(3, 2)
  notes               String?
  createdById         String
  updatedById         String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  createdBy           User          @relation("VendorCreatedBy", fields: [createdById], references: [id])
  tenant              Tenant        @relation("OperationsVendors", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy           User?         @relation("VendorUpdatedBy", fields: [updatedById], references: [id])
  serviceRequests     OperationsServiceRequest[]
  maintenanceRecords  OperationsMaintenance[]

  @@index([tenantId])
  @@index([status])
  @@index([category])
  @@index([name])
}

model OperationsServiceRequest {
  id              String                  @id @default(cuid())
  tenantId        String
  requestNumber   String                   @unique
  title           String
  description     String?
  category        String?
  status          ServiceRequestStatus     @default(OPEN)
  priority        ServiceRequestPriority   @default(MEDIUM)
  requestedById   String
  assignedToId    String?
  vendorId        String?
  location        String?
  requestedDate   DateTime                @default(now())
  dueDate         DateTime?
  resolvedDate   DateTime?
  resolution      String?
  slaTarget       Int?                    // Target resolution time in hours
  slaActual       Int?                    // Actual resolution time in hours
  cost            Decimal?                 @db.Decimal(15, 2)
  notes           String?
  createdById     String
  updatedById     String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  assignedTo      User?                   @relation("ServiceRequestAssignedTo", fields: [assignedToId], references: [id])
  createdBy       User                    @relation("ServiceRequestCreatedBy", fields: [createdById], references: [id])
  requestedBy     User                    @relation("ServiceRequestRequestedBy", fields: [requestedById], references: [id])
  tenant          Tenant                  @relation("OperationsServiceRequests", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy       User?                   @relation("ServiceRequestUpdatedBy", fields: [updatedById], references: [id])
  vendor          OperationsVendor?       @relation(fields: [vendorId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([priority])
  @@index([requestedById])
  @@index([assignedToId])
  @@index([vendorId])
  @@index([category])
  @@index([requestedDate])
}

model OperationsMaintenance {
  id                  String            @id @default(cuid())
  tenantId            String
  maintenanceNumber   String             @unique
  assetId             String?
  vendorId            String?
  type                MaintenanceType
  status              MaintenanceStatus  @default(SCHEDULED)
  title               String
  description         String?
  scheduledDate       DateTime
  completedDate       DateTime?
  technicianId        String?
  technicianName      String?
  cost                Decimal?           @db.Decimal(15, 2)
  frequency           String?            // e.g., "Monthly", "Quarterly"
  nextScheduledDate   DateTime?
  notes               String?
  createdById         String
  updatedById         String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  createdBy           User               @relation("MaintenanceCreatedBy", fields: [createdById], references: [id])
  technician          User?              @relation("MaintenanceTechnician", fields: [technicianId], references: [id])
  tenant              Tenant             @relation("OperationsMaintenance", fields: [tenantId], references: [id], onDelete: Cascade)
  updatedBy           User?              @relation("MaintenanceUpdatedBy", fields: [updatedById], references: [id])
  vendor              OperationsVendor?  @relation(fields: [vendorId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([type])
  @@index([assetId])
  @@index([vendorId])
  @@index([technicianId])
  @@index([scheduledDate])
}

model Call {
  id            String            @id @default(cuid())
  tenantId      String
  roomId        String            @unique
  type          CallType          @default(ONE_ON_ONE)
  status        CallStatus        @default(INITIATED)
  scheduledAt   DateTime?
  startedAt     DateTime?
  endedAt       DateTime?
  duration      Int?              // seconds
  createdById   String
  title         String?
  description   String?
  participants  CallParticipant[]
  recordings    CallRecording[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  createdBy     User              @relation("CallCreatedBy", fields: [createdById], references: [id])
  tenant        Tenant            @relation("Calls", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdById])
  @@index([status])
  @@index([roomId])
  @@index([scheduledAt])
}

model CallParticipant {
  id              String            @id @default(cuid())
  callId          String
  userId          String
  joinedAt        DateTime          @default(now())
  leftAt          DateTime?
  role            ParticipantRole   @default(PARTICIPANT)
  isMuted         Boolean           @default(false)
  isVideoOn       Boolean           @default(true)
  isScreenSharing Boolean           @default(false)
  call            Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  user            User              @relation("CallParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@index([userId])
  @@unique([callId, userId])
}

model CallRecording {
  id          String   @id @default(cuid())
  callId      String
  fileUrl     String
  fileSize    Int
  duration    Int      // seconds
  format      String   // mp4, webm
  recordedBy  String
  createdAt   DateTime @default(now())
  call        Call     @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@index([recordedBy])
}

// ============================================
// Reporting System Models
// ============================================

// Data Source - Available data sources for reporting
model DataSource {
  id            String   @id @default(cuid())
  name          String
  description   String?
  type          String   // DATABASE_TABLE, API, FILE, CUSTOM_QUERY
  connection    Json     // Connection details (encrypted)
  schema        Json?    // Table/field metadata
  
  // Functional Area
  functionalArea String? // FINANCE, SALES, OPERATIONS, IT, PROJECTS, RECRUITMENT, CROSS_FUNCTIONAL
  
  tenantId      String?
  tenant         Tenant?   @relation("DataSourceTenant", fields: [tenantId], references: [id])
  
  // Access Control
  accessibleBy  DataSourceAccess[]
  
  // Metadata
  lastSynced    DateTime?
  syncFrequency String?  // REAL_TIME, HOURLY, DAILY
  
  // Usage
  queries       Query[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([type])
  @@index([functionalArea])
}

// Data Source Access Control
model DataSourceAccess {
  id          String     @id @default(cuid())
  dataSourceId String
  dataSource  DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?      @relation("DataSourceAccessUser", fields: [userId], references: [id])
  userRole    String?    // UserRole enum
  permission  String     // READ, WRITE
  createdAt   DateTime   @default(now())
  
  @@unique([dataSourceId, userId])
  @@index([dataSourceId])
  @@index([userId])
}

// Query - Reusable data queries
model Query {
  id            String   @id @default(cuid())
  name          String
  description   String?
  dataSourceId  String
  dataSource    DataSource @relation(fields: [dataSourceId], references: [id])
  
  // Query Definition
  sql           String?  // Raw SQL (for advanced users)
  queryBuilder  Json?    // Visual query builder JSON
  parameters    Json?    // Parameter definitions
  
  // Security
  securityFilters Json?  // Auto-injected RLS filters
  
  // Results & Cache
  cachedResult  Json?
  cacheExpiry   DateTime?
  
  // Metadata
  executionTime Int?     // milliseconds
  rowCount      Int?
  createdById   String
  createdBy     User     @relation("QueryCreator", fields: [createdById], references: [id])
  
  // Usage
  visualizations Visualization[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([dataSourceId])
  @@index([createdById])
}

// Visualization Library - Reusable visualization cards
model Visualization {
  id            String   @id @default(cuid())
  name          String
  description   String?
  type          String   // CHART, TABLE, KPI, MAP, etc.
  
  // Functional Area
  functionalArea String  // FINANCE, SALES, OPERATIONS, IT, PROJECTS, RECRUITMENT, CROSS_FUNCTIONAL
  
  // Query & Data (optional for text charts)
  queryId       String?
  query         Query?    @relation(fields: [queryId], references: [id])
  
  // Visualization Config
  config        Json     // Chart config, colors, axes, etc.
  
  // Layout (for when added to dashboard)
  defaultWidth  Int      @default(6)  // Grid columns (1-12)
  defaultHeight Int      @default(4)  // Grid rows
  
  // Metadata
  createdById   String
  createdBy     User     @relation("VisualizationCreator", fields: [createdById], references: [id])
  tenantId      String?
  tenant         Tenant?   @relation("VisualizationTenant", fields: [tenantId], references: [id])
  
  // Sharing
  isPublic      Boolean  @default(false)
  isTemplate    Boolean  @default(false)
  tags          String[]
  
  // Usage tracking
  usedInDashboards DashboardVisualization[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([functionalArea])
  @@index([createdById])
  @@index([tenantId])
}

// Dashboard - User-created dashboard collections
model Dashboard {
  id            String   @id @default(cuid())
  name          String
  description   String?
  
  // Functional Area
  functionalArea String  // FINANCE, SALES, OPERATIONS, IT, PROJECTS, RECRUITMENT
  
  // Owner
  createdById   String
  createdBy     User     @relation("DashboardCreator", fields: [createdById], references: [id])
  tenantId      String?
  tenant         Tenant?   @relation("DashboardTenant", fields: [tenantId], references: [id])
  
  // Layout Configuration
  layout        Json     // Grid layout configuration
  
  // Refresh Configuration
  autoRefresh   Boolean  @default(false)
  refreshInterval Int?    // seconds (e.g., 300 for 5 minutes)
  lastRefreshed  DateTime?
  
  // Visualizations in this dashboard
  visualizations DashboardVisualization[]
  
  // Sharing
  isPublic      Boolean  @default(false)
  sharedWith    DashboardShare[]
  permissions   DashboardPermission[]
  
  // Metadata
  isDefault     Boolean  @default(false) // Default dashboard for functional area
  order         Int      @default(0)     // Order in tabs
  tags          String[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([functionalArea])
  @@index([createdById])
  @@index([tenantId])
  @@index([isDefault, functionalArea])
}

// Junction table: Dashboard  Visualization
model DashboardVisualization {
  id              String   @id @default(cuid())
  dashboardId     String
  dashboard       Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  visualizationId String
  visualization   Visualization @relation(fields: [visualizationId], references: [id], onDelete: Cascade)
  
  // Position in dashboard
  position        Json     // { x, y, w, h } for grid layout
  order           Int      @default(0)
  
  // Per-dashboard customization (overrides visualization defaults)
  customConfig    Json?    // Optional: dashboard-specific config overrides
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([dashboardId, visualizationId])
  @@index([dashboardId])
  @@index([visualizationId])
}

// Dashboard Sharing
model DashboardShare {
  id          String   @id @default(cuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation("DashboardShareUser", fields: [userId], references: [id])
  permission  String   // VIEW, EDIT, ADMIN
  createdAt   DateTime @default(now())
  
  @@unique([dashboardId, userId])
  @@index([dashboardId])
  @@index([userId])
}

// Dashboard Permissions (Role-based)
model DashboardPermission {
  id          String   @id @default(cuid())
  dashboardId String
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  userRole    String?  // UserRole enum
  groupRole   String?  // GroupRole enum
  permission  String   // VIEW, EDIT, ADMIN
  createdAt   DateTime @default(now())
  
  @@index([dashboardId])
}
