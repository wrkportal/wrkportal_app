// Prisma Schema for Project Management System
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password for credentials login
  
  // Profile Information
  firstName     String?
  lastName      String?
  avatar        String?
  phone         String?
  location      String?
  department    String?
  timezone      String    @default("UTC")
  locale        String    @default("en")
  
  // Organization & Role
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role          UserRole  @default(TEAM_MEMBER)
  groupRole     GroupRole? // For GROUP type workspaces
  orgUnitId     String?
  orgUnit       OrgUnit?  @relation(fields: [orgUnitId], references: [id])
  
  // Reporting Structure (Manager/Lead)
  reportsToId   String?
  reportsTo     User?     @relation("ReportsTo", fields: [reportsToId], references: [id], onDelete: SetNull)
  directReports User[]    @relation("ReportsTo")
  
  // Landing Page Preference
  landingPage   String?
  
  // Status
  status        UserStatus @default(ACTIVE)
  lastLogin     DateTime?
  
  // Password Reset
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  skills        UserSkill[]
  managedProjects Project[] @relation("ProjectManager")
  teamMemberships ProjectMember[]
  assignedTasks Task[]   @relation("AssignedTasks")
  createdTasks  Task[]   @relation("CreatedTasks")
  taskComments  TaskComment[]
  timesheets    Timesheet[]
  timeTrackings TimeTracking[]
  createdProjects Project[] @relation("CreatedBy")
  createdPrograms Program[] @relation("CreatedBy")
  
  // Approval relations
  requestedApprovals ApprovalApprover[]
  createdApprovals   Approval[] @relation("ApprovalRequester")
  finalApprovals     Approval[] @relation("ApprovalFinalApprover")
  finalRejections    Approval[] @relation("ApprovalFinalRejecter")
  
  // Notifications
  notifications      Notification[] @relation("UserNotifications")
  
  // Audit Logs
  auditLogs          AuditLog[] @relation("UserAuditLogs")
  
  // Tutorials
  createdTutorials   Tutorial[] @relation("TutorialCreator")
  
  // Collaborations
  createdCollaborations     Collaboration[] @relation("CollaborationCreator")
  collaborationMemberships  CollaborationMember[]
  collaborationMessages     CollaborationMessage[]
  collaborationFiles        CollaborationFile[]
  collaborationSuggestions  CollaborationSuggestion[]
  createdReminders          Reminder[] @relation("CreatedReminders")
  reminders                 Reminder[] @relation("UserReminders")
  respondedSuggestions      CollaborationSuggestion[] @relation("SuggestionResponder")
  defaultLayouts            DefaultLayout[]
  reportingFiles            ReportingFile[]
  dashboardsCreated         ReportingDashboard[] @relation("DashboardCreatedBy")
  dashboardsUpdated         ReportingDashboard[] @relation("DashboardUpdatedBy")

  
  // Invitations
  sentInvitations           TenantInvitation[] @relation("InvitedBy")
  
  @@index([email])
  @@index([tenantId])
  @@index([orgUnitId])
  @@index([reportsToId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// MULTI-TENANCY
// ============================================

model Tenant {
  id          String   @id @default(cuid())
  name        String
  domain      String?  @unique
  logo        String?
  settings    Json?
  
  // Workspace Type (ORGANIZATION or GROUP)
  type        WorkspaceType @default(ORGANIZATION)
  
  // Domain Verification (for ORGANIZATION type)
  domainVerified      Boolean   @default(false)
  verificationCode    String?   @unique
  verificationMethod  String?   // 'DNS', 'EMAIL', 'MANUAL'
  verifiedAt          DateTime?
  verifiedById        String?
  codeExpiresAt       DateTime?
  autoJoinEnabled     Boolean   @default(false) // Allow domain users to auto-join after verification
  
  // Subscription
  plan        String   @default("free") // free, professional, enterprise
  maxUsers    Int      @default(10)
  
  // Status
  status      String   @default("active") // active, suspended, trial
  trialEndsAt DateTime?
  
  // SSO Configuration
  ssoEnabled  Boolean  @default(false)
  ssoProvider SSOProvider?
  ssoConfig   Json?    // Provider-specific configuration (SAML cert, OIDC endpoints, etc.)
  
  // Data Retention Settings (in days, -1 = forever)
  auditLogRetentionDays      Int @default(2555)  // 7 years for compliance
  taskRetentionDays          Int @default(1825)  // 5 years
  notificationRetentionDays  Int @default(90)    // 90 days
  projectRetentionDays       Int @default(1825)  // 5 years
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  orgUnits    OrgUnit[]
  programs    Program[]
  projects    Project[]
  tasks       Task[]
  notifications Notification[]
  auditLogs     AuditLog[]
  tutorials     Tutorial[]
  collaborations Collaboration[]
  invitations   TenantInvitation[]
  reminders     Reminder[]
  defaultLayouts DefaultLayout[]
  reportingFiles ReportingFile[]
  
  @@index([domain])
  @@index([verificationCode])
}

model OrgUnit {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  parentId    String?
  parent      OrgUnit? @relation("OrgUnitHierarchy", fields: [parentId], references: [id])
  children    OrgUnit[] @relation("OrgUnitHierarchy")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@index([tenantId])
  @@index([parentId])
}

// Tenant Invitation System
model TenantInvitation {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email       String
  token       String   @unique
  role        UserRole @default(TEAM_MEMBER)
  
  invitedById String
  invitedBy   User     @relation("InvitedBy", fields: [invitedById], references: [id])
  
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime
  acceptedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@index([status])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================
// PROGRAMS & PROJECTS
// ============================================

model Program {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  code        String   @unique
  description String?
  
  // Dates
  startDate   DateTime
  endDate     DateTime
  
  // Ownership
  ownerId     String
  owner       User     @relation("CreatedBy", fields: [ownerId], references: [id])
  
  // Budget
  budget      Decimal  @db.Decimal(15, 2)
  
  // Status
  status      ProgramStatus @default(PLANNED)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  projects    Project[]
  
  @@index([tenantId])
  @@index([ownerId])
  @@index([code])
}

model Project {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  programId   String?
  program     Program? @relation(fields: [programId], references: [id])
  
  name        String
  code        String   @unique
  description String?
  
  // Dates
  startDate   DateTime
  endDate     DateTime
  
  // Ownership
  managerId   String
  manager     User     @relation("ProjectManager", fields: [managerId], references: [id])
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  
  // Status
  status      ProjectStatus @default(PLANNED)
  ragStatus   RAGStatus     @default(GREEN)
  progress    Int           @default(0)
  
  // Budget
  budget      Json // Will store budget details as JSON
  
  // Initiate Phase Data
  initiateData Json? // Stores checklist, stakeholders, objectives, charter
  
  // Planning Phase Data
  planningData Json? // Stores milestones, tasks, deliverables
  
  // Execution Phase Data
  executionData Json? // Stores actual values vs planned
  
  // Closure Phase Data
  closureData Json? // Stores checklist, lessons learned
  
  // Soft Delete
  deletedAt   DateTime?
  deletedById String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  teamMembers ProjectMember[]
  tasks       Task[]
  risks       Risk[]
  issues      Issue[]
  changeRequests ChangeRequest[]
  timesheets  Timesheet[]
  collaborations Collaboration[]
  
  @@index([tenantId])
  @@index([programId])
  @@index([managerId])
  @@index([code])
  @@index([deletedAt])
}

model ProjectMember {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        String
  allocation  Int      @default(100) // Percentage
  
  joinedAt    DateTime @default(now())
  leftAt      DateTime?
  
  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// ============================================
// TASKS & WORK ITEMS
// ============================================

model Task {
  id          String   @id @default(cuid())
  
  // Multi-tenancy
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Project (optional - for "Not a Project" tasks)
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  
  // Assignment
  assigneeId  String?
  assignee    User?    @relation("AssignedTasks", fields: [assigneeId], references: [id])
  
  // Creator
  createdById String
  createdBy   User     @relation("CreatedTasks", fields: [createdById], references: [id])
  
  // Status & Priority
  status      TaskStatus   @default(TODO)
  priority    Priority     @default(MEDIUM)
  
  // Dates
  dueDate     DateTime?
  startDate   DateTime?
  completedAt DateTime?
  
  // Time Tracking
  estimatedHours Decimal? @db.Decimal(8, 2)
  actualHours    Decimal? @db.Decimal(8, 2)
  
  // Tags (for storing frequency, reference point, etc.)
  tags        String[]
  
  // Source tracking (for WBS sync)
  sourceType  String?  // 'WBS', 'MANUAL', 'IMPORTED'
  sourceId    String?  // Reference to WBS task ID in planningData
  
  // Hierarchy
  parentId    String?
  parent      Task?    @relation("TaskHierarchy", fields: [parentId], references: [id])
  subtasks    Task[]   @relation("TaskHierarchy")
  
  // Comments
  comments    TaskComment[]
  
  // Time Tracking
  timeTrackings TimeTracking[]
  
  // Collaborations
  collaborations Collaboration[]
  
  // Soft Delete
  deletedAt   DateTime?
  deletedById String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([projectId])
  @@index([assigneeId])
  @@index([createdById])
  @@index([parentId])
  @@index([deletedAt])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  content   String   @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([taskId])
  @@index([userId])
}

model TimeTracking {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // Time tracking
  startTime   DateTime
  endTime     DateTime?
  duration    Int?     // Duration in seconds (calculated when endTime is set)
  
  // Date for day-wise grouping
  date        DateTime @default(now()) @db.Date
  
  // Optional notes about what was done
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([taskId])
  @@index([userId])
  @@index([date])
}

// ============================================
// RISK & ISSUE MANAGEMENT (RAID)
// ============================================

model Risk {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  category    String
  
  // Risk Assessment
  probability RiskProbability
  impact      RiskImpact
  level       RiskLevel       // Calculated: probability Ã— impact
  
  // Mitigation
  mitigation  String?
  contingency String?
  
  // Ownership
  ownerId     String
  
  // Status
  status      RiskStatus @default(IDENTIFIED)
  
  // Dates
  identifiedDate DateTime @default(now())
  reviewDate     DateTime?
  closedDate     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
}

model Issue {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  category    String
  
  // Priority & Severity
  priority    Priority
  severity    IssueSeverity
  
  // Resolution
  resolution  String?
  
  // Status
  status      IssueStatus @default(OPEN)
  
  // Dates
  reportedDate  DateTime @default(now())
  resolvedDate  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
}

// ============================================
// CHANGE CONTROL
// ============================================

model ChangeRequest {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  category    String
  justification String
  
  // Impact Assessment
  impact      Json // { cost?, schedule?, scope? }
  
  // Priority
  priority    Priority
  
  // Workflow
  status      ChangeRequestStatus @default(DRAFT)
  requestedBy String
  requestedDate DateTime @default(now())
  approvedBy  String?
  approvedDate DateTime?
  implementedDate DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
}

// ============================================
// GOALS & OKRs
// ============================================

model Goal {
  id          String   @id @default(cuid())
  tenantId    String
  
  title       String
  description String?
  level       GoalLevel @default(TEAM) // Company, Department, Team, Individual
  quarter     String
  year        Int
  
  // Ownership
  ownerId     String
  
  // Status
  status      GoalStatus @default(ACTIVE)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  keyResults  KeyResult[]
  
  @@index([tenantId])
  @@index([ownerId])
}

model KeyResult {
  id          String   @id @default(cuid())
  goalId      String
  goal        Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  
  // Measurement
  startValue  Decimal  @db.Decimal(15, 2)
  targetValue Decimal  @db.Decimal(15, 2)
  currentValue Decimal @db.Decimal(15, 2)
  unit        String
  
  // Weight and confidence
  weight      Int      @default(25) // Percentage weight in the goal
  confidence  Int      @default(5)  // 1-10 scale
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  checkIns    KRCheckIn[]
  
  @@index([goalId])
}

model KRCheckIn {
  id            String   @id @default(cuid())
  keyResultId   String
  keyResult     KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  
  value         Decimal  @db.Decimal(15, 2)
  confidence    Int      // 1-10 scale
  narrative     String?  @db.Text
  
  createdById   String
  createdAt     DateTime @default(now())
  
  @@index([keyResultId])
  @@index([createdAt])
}

// ============================================
// TIME TRACKING
// ============================================

model Timesheet {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Time Entry
  date        DateTime
  hours       Decimal  @db.Decimal(5, 2)
  description String?
  
  // Billing
  billable    Boolean  @default(true)
  
  // Status
  status      TimesheetStatus @default(DRAFT)
  submittedAt DateTime?
  approvedAt  DateTime?
  approvedBy  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([date])
}

// ============================================
// APPROVAL WORKFLOW
// ============================================

model Approval {
  id          String   @id @default(cuid())
  tenantId    String
  
  // What is being approved
  type        ApprovalType
  title       String
  description String?  @db.Text
  
  // Reference to the entity being approved (optional)
  entityId    String?  // Can be projectId, charterID, etc.
  entityType  String?  // "project", "charter", "budget", etc.
  
  // Document/Data being approved
  documentData Json?   // Store the actual data/document
  
  // Approval workflow
  requestedById String
  requestedBy   User     @relation("ApprovalRequester", fields: [requestedById], references: [id])
  requestedAt   DateTime @default(now())
  
  // Approvers (many-to-many through ApprovalApprover)
  approvers     ApprovalApprover[]
  
  // CC list (stored as JSON array of user IDs)
  ccList        String[] // Array of user IDs
  
  // Message from requester
  message       String?  @db.Text
  
  // Overall status
  status        ApprovalStatus @default(PENDING)
  
  // Final decision
  approvedAt    DateTime?
  approvedById  String?
  approvedBy    User?    @relation("ApprovalFinalApprover", fields: [approvedById], references: [id])
  
  rejectedAt    DateTime?
  rejectedById  String?
  rejectedBy    User?    @relation("ApprovalFinalRejecter", fields: [rejectedById], references: [id])
  
  // Audit
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([requestedById])
  @@index([status])
  @@index([entityId])
}

model ApprovalApprover {
  id          String   @id @default(cuid())
  approvalId  String
  approval    Approval @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // Individual approver status
  status      ApprovalStatus @default(PENDING)
  
  // Response
  approvedAt  DateTime?
  rejectedAt  DateTime?
  comments    String?  @db.Text
  
  // Notifications
  notifiedAt  DateTime?
  viewedAt    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([approvalId, userId])
  @@index([approvalId])
  @@index([userId])
  @@index([status])
}

// ============================================
// SKILLS MANAGEMENT
// ============================================

model Skill {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  userSkills  UserSkill[]
}

model UserSkill {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  skillId     String
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  
  level       SkillLevel
  yearsOfExperience Decimal? @db.Decimal(4, 1)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  PLATFORM_OWNER        // Platform-level super admin (cross-tenant access)
  TENANT_SUPER_ADMIN
  ORG_ADMIN
  PMO_LEAD
  PROJECT_MANAGER
  TEAM_MEMBER
  RESOURCE_MANAGER
  FINANCE_CONTROLLER
  EXECUTIVE
  CLIENT_STAKEHOLDER
  COMPLIANCE_AUDITOR
  INTEGRATION_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  SUSPENDED
}

enum WorkspaceType {
  ORGANIZATION  // Full enterprise features
  GROUP         // Lightweight, simplified for teams/freelancers
}

enum GroupRole {
  OWNER         // Creator, full control
  ADMIN         // Can invite, manage members
  MEMBER        // Can collaborate
  GUEST         // View-only access
}

enum ProgramStatus {
  PLANNED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectStatus {
  PLANNED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum RAGStatus {
  RED
  AMBER
  GREEN
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  DONE
  CANCELLED
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum RiskProbability {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum RiskImpact {
  NEGLIGIBLE
  MINOR
  MODERATE
  MAJOR
  CRITICAL
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  IDENTIFIED
  ACTIVE
  MITIGATED
  CLOSED
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssueSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ChangeRequestStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum GoalLevel {
  COMPANY
  DEPARTMENT
  TEAM
  INDIVIDUAL
}

enum GoalStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  PROJECT_CHARTER
  PROJECT_CLOSURE
  BUDGET
  CHANGE_REQUEST
  TIMESHEET
  OTHER
}

enum SSOProvider {
  SAML
  OIDC
  AZURE_AD
  GOOGLE_WORKSPACE
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  message     String
  
  // Reference to related entity (optional)
  entityType  String?
  entityId    String?
  
  read        Boolean  @default(false)
  priority    NotificationPriority @default(MEDIUM)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, read])
  @@index([tenantId])
  @@index([createdAt])
}

enum NotificationType {
  MENTION
  ASSIGNMENT
  APPROVAL
  DEADLINE
  STATUS_CHANGE
  COMMENT
  MESSAGE
  TASK_COMPLETED
  PROJECT_UPDATE
  OVERDUE_TASK
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// REMINDERS
// ============================================

model Reminder {
  id          String   @id @default(cuid())
  
  // Multi-tenancy
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Who created the reminder
  createdById String
  createdBy   User     @relation("CreatedReminders", fields: [createdById], references: [id])
  
  // Who the reminder is for
  userId      String
  user        User     @relation("UserReminders", fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String?  @db.Text
  remindAt    DateTime
  
  // Source reference (optional - can link to message, task, etc.)
  sourceType  String?  // 'MESSAGE', 'TASK', 'MANUAL'
  sourceId    String?
  
  // Status
  completed   Boolean  @default(false)
  dismissed   Boolean  @default(false)
  notified    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, remindAt, completed])
  @@index([tenantId])
  @@index([createdById])
}

// ============================================
// AUDIT LOGGING
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  action      AuditAction
  entity      AuditEntity
  entityId    String?
  entityName  String?
  changes     Json?    // Store before/after values
  ipAddress   String?
  userAgent   String?
  metadata    Json?    // Additional context
  createdAt   DateTime @default(now())
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, createdAt])
  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PERMISSION_CHANGE
  SSO_CONFIG_CHANGE
  RETENTION_CONFIG_CHANGE
  DATA_CLEANUP
  EXPORT
  IMPORT
}

enum AuditEntity {
  USER
  PROJECT
  TASK
  PROGRAM
  INITIATIVE
  GOAL
  OKR
  RISK
  ISSUE
  APPROVAL
  REPORT
  NOTIFICATION
  ORG_UNIT
  TENANT
  SSO_SETTINGS
  RETENTION_SETTINGS
  TUTORIAL
  COLLABORATION
}

// ============================================
// ACADEMY TUTORIALS
// ============================================

model Tutorial {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title       String
  description String   @db.Text
  type        TutorialType
  duration    String   // e.g., "10 min"
  level       TutorialLevel
  category    String   // e.g., "Getting Started", "Planning & Execution"
  section     TutorialSection  // project-management or tools-workings
  
  // Video/Content URL
  videoUrl    String?  @db.Text
  contentText String?  @db.Text
  
  // File attachment (if uploaded)
  fileUrl     String?  @db.Text
  fileName    String?
  fileSize    Int?
  
  // Metadata
  thumbnail   String?  @db.Text
  order       Int      @default(0)  // Display order within category
  isPublished Boolean  @default(true)
  viewCount   Int      @default(0)
  
  // Creator
  createdById String
  createdBy   User     @relation("TutorialCreator", fields: [createdById], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([section, category])
  @@index([isPublished])
  @@index([order])
}

enum TutorialType {
  VIDEO
  TEXT
  INTERACTIVE
}

enum TutorialLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum TutorialSection {
  PROJECT_MANAGEMENT
  TOOLS_WORKINGS
}

// ============================================
// COLLABORATION SYSTEM
// ============================================

model Collaboration {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  description String?  @db.Text
  type        CollaborationType  // PROJECT, TASK, GENERAL, etc.
  
  // Optional links to entities
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // Creator
  createdById String
  createdBy   User     @relation("CollaborationCreator", fields: [createdById], references: [id])
  
  // Status
  status      CollaborationStatus @default(ACTIVE)
  isArchived  Boolean  @default(false)
  
  // Relations
  members     CollaborationMember[]
  messages    CollaborationMessage[]
  files       CollaborationFile[]
  suggestions CollaborationSuggestion[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([projectId])
  @@index([taskId])
  @@index([createdById])
  @@index([status])
}

model CollaborationMember {
  id              String   @id @default(cuid())
  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role            CollaborationRole @default(MEMBER)
  canEdit         Boolean  @default(false)
  canInvite       Boolean  @default(false)
  canDelete       Boolean  @default(false)
  
  joinedAt        DateTime @default(now())
  lastSeenAt      DateTime?
  
  @@unique([collaborationId, userId])
  @@index([collaborationId])
  @@index([userId])
}

model CollaborationMessage {
  id              String   @id @default(cuid())
  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content         String   @db.Text
  mentions        String[] // Array of user IDs mentioned in message
  
  // Optional reply
  parentId        String?
  parent          CollaborationMessage? @relation("MessageReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies         CollaborationMessage[] @relation("MessageReplies")
  
  isEdited        Boolean  @default(false)
  isDeleted       Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([collaborationId])
  @@index([userId])
  @@index([parentId])
}

model CollaborationFile {
  id              String   @id @default(cuid())
  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fileName        String
  fileUrl         String   @db.Text
  fileSize        Int
  fileType        String   // mime type
  
  description     String?  @db.Text
  
  uploadedAt      DateTime @default(now())
  
  @@index([collaborationId])
  @@index([userId])
}

model CollaborationSuggestion {
  id              String   @id @default(cuid())
  collaborationId String
  collaboration   Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title           String
  description     String   @db.Text
  suggestionType  SuggestionType  // CHANGE, ADDITION, REMOVAL, GENERAL
  
  // Optional file/content reference
  targetType      String?  // 'file', 'text', 'task', etc.
  targetId        String?
  originalContent String?  @db.Text
  suggestedContent String? @db.Text
  
  status          SuggestionStatus @default(PENDING)
  
  // Response
  respondedById   String?
  respondedBy     User?    @relation("SuggestionResponder", fields: [respondedById], references: [id])
  responseNote    String?  @db.Text
  respondedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([collaborationId])
  @@index([userId])
  @@index([status])
}

enum CollaborationType {
  PROJECT
  TASK
  GENERAL
  BRAINSTORM
  REVIEW
  PLANNING
}

enum CollaborationStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum CollaborationRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum SuggestionType {
  CHANGE
  ADDITION
  REMOVAL
  GENERAL
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
  IMPLEMENTED
}

// ============================================
// DEFAULT LAYOUTS (Platform Owner Configuration)
// ============================================

model DefaultLayout {
  id          String   @id @default(cuid())
  
  // Scope
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Page identifier (e.g., "my-work", "roadmap", "collaborate")
  pageKey     String
  
  // Target role (null = applies to all roles)
  targetRole  UserRole?
  
  // Layout configuration (JSON)
  layoutData  Json     // Stores widgets, positions, sizes, etc.
  
  // Metadata
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, pageKey, targetRole])
  @@index([tenantId, pageKey])
  @@index([createdById])
}

// ============================================
// REPORTING STUDIO
// ============================================

model ReportingFile {
  id            String   @id @default(cuid())
  
  // File information
  name          String   // Unique filename stored on server
  originalName  String   // Original filename from user
  filePath      String   // Full path to file on server
  size          Int      // File size in bytes
  type          String   // MIME type
  
  // Data metadata
  rowCount      Int?
  columnCount   Int?
  
  // Merge tracking
  isMerged      Boolean  @default(false) // Is this a merged file?
  mergeConfig   Json?    // Store the merge configuration (joins, source files)
  sourceFiles   String[] @default([]) // IDs of source files used in merge
  
  // Ownership
  uploadedBy    String
  uploader      User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Timestamps
  uploadedAt    DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([uploadedBy])
  @@index([uploadedAt])
}

model ReportingDashboard {
  id            String   @id @default(cuid())
  
  // Dashboard information
  name          String   // Dashboard name/title
  description   String?  // Optional description
  
  // Configuration (stored as JSON)
  configuration Json     // Contains: charts, layout, pageBackgroundColor, activeFilters
  
  // Ownership & Tracking
  createdBy     String
  createdByUser User     @relation("DashboardCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  
  updatedBy     String
  updatedByUser User     @relation("DashboardUpdatedBy", fields: [updatedBy], references: [id], onDelete: Cascade)
  
  // Soft delete
  deletedAt     DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([createdBy])
  @@index([updatedBy])
  @@index([createdAt])
  @@index([deletedAt])
}

